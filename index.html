<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Premium Smokeshop - Catálogo Digital</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Poppins', sans-serif;
        }
        
        .gradient-bg {
            background: linear-gradient(135deg, #4c1d95 0%, #7c3aed 25%, #a855f7 50%, #22c55e 75%, #ffffff 100%);
        }
        
        .gradient-btn {
            background: linear-gradient(135deg, #4c1d95, #7c3aed, #a855f7);
            transition: all 0.3s ease;
        }
        
        .gradient-btn:hover {
            background: linear-gradient(135deg, #3730a3, #6d28d9, #9333ea);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(124, 58, 237, 0.3);
        }
        
        .premium-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(168, 85, 247, 0.2);
            transition: all 0.3s ease;
        }
        
        .premium-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(124, 58, 237, 0.15);
        }
        
        .modal {
            display: none;
            position: fixed;
            z-index: 50000 !important;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
        }
        
        .modal.high-priority {
            z-index: 55000 !important;
        }

        .admin-modal {
            z-index: 60000 !important;
        }

        .admin-panel-modal {
            z-index: 65000 !important;
        }

        .product-modal {
            z-index: 70000 !important;
        }

        .customer-edit-modal {
            z-index: 75000 !important;
        }

        .order-details-modal {
            z-index: 80000 !important;
        }

        .order-status-modal {
            z-index: 85000 !important;
        }

        .confirmation-modal {
            z-index: 9999999 !important;
        }

        .phone-verification-modal {
            z-index: 9999998 !important;
        }

        .download-modal {
            z-index: 9999997 !important;
        }

        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.4;
            max-height: 2.8em;
        }

        .confirmation-modal .modal-content,
        .phone-verification-modal .modal-content {
            position: relative !important;
            z-index: 10000000 !important;
            background: white !important;
            border-radius: 20px !important;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5) !important;
        }
        
        .modal-content {
            background: linear-gradient(135deg, #ffffff, #f8fafc);
            margin: 2% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            border: 2px solid rgba(168, 85, 247, 0.3);
        }
        
        .star-rating {
            display: flex;
            gap: 5px;
            font-size: 24px;
        }
        
        .star {
            color: #d1d5db;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .star.active {
            color: #fbbf24;
        }
        
        .cart-badge {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        .whatsapp-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 999;
            background: linear-gradient(135deg, #25d366, #128c7e);
            animation: bounce 2s infinite;
        }
        
        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
            40% { transform: translateY(-10px); }
            60% { transform: translateY(-5px); }
        }
        
        .logo-container {
            position: relative;
            overflow: hidden;
        }
        
        .logo-bg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0.1;
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }

        .sync-indicator {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1000;
            background: rgba(34, 197, 94, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            display: none;
            animation: slideIn 0.3s ease;
        }

        .sync-indicator.offline {
            background: rgba(239, 68, 68, 0.9);
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <!-- Indicador de sincronización -->
    <div id="syncIndicator" class="sync-indicator">
        <i class="fas fa-sync-alt mr-1"></i>
        <span id="syncText">Sincronizado</span>
    </div>

    <!-- Header -->
    <header class="bg-white/90 backdrop-blur-md shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <div class="logo-container flex items-center space-x-4">
                    <div id="logoDisplay" class="w-16 h-16 bg-gradient-to-r from-purple-800 to-purple-600 rounded-full flex items-center justify-center text-white font-bold text-xl">
                        PS
                    </div>
                    <div class="flex items-center space-x-2">
                        <h1 id="shopTitle" class="text-2xl font-bold bg-gradient-to-r from-purple-800 to-green-600 bg-clip-text text-transparent">
                            Tu Smokeshop
                        </h1>
                    </div>
                </div>
                
                <div class="flex items-center space-x-4">
                    <button onclick="openCart()" class="relative gradient-btn text-white px-6 py-3 rounded-full font-semibold">
                        <i class="fas fa-shopping-cart mr-2"></i>
                        Carrito
                        <span id="cartBadge" class="absolute -top-2 -right-2 cart-badge text-white text-xs rounded-full w-6 h-6 flex items-center justify-center">0</span>
                    </button>
                    <button onclick="openAdminLogin()" class="bg-gray-800 text-white px-4 py-2 rounded-full text-sm">
                        <i class="fas fa-cog mr-1"></i>
                        Admin
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-8">
        <!-- Categories -->
        <section class="mb-12">
            <h2 class="text-3xl font-bold text-center text-white mb-8">Nuestras Categorías Premium</h2>
            <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-6" id="categoriesGrid">
                <!-- Categories will be loaded here -->
            </div>
        </section>

        <!-- Products -->
        <section>
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-3xl font-bold text-white">Productos Exclusivos</h2>
                <button onclick="showAllProducts()" class="bg-white/20 backdrop-blur-md text-white px-4 py-2 rounded-full hover:bg-white/30 transition-all">
                    <i class="fas fa-grid-3x3 mr-2"></i>Ver Todos
                </button>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-8" id="productsGrid">
                <!-- Products will be loaded here -->
            </div>
        </section>
    </main>

    <!-- Cart Modal -->
    <div id="cartModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-purple-800">Tu Carrito</h2>
                <button onclick="closeCart()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="cartItems" class="mb-6">
                <!-- Cart items will be displayed here -->
            </div>
            <div class="border-t pt-4">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-xl font-bold">Total:</span>
                    <span id="cartTotal" class="text-2xl font-bold text-green-600">$0</span>
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-medium mb-2">Método de Pago:</label>
                    <select id="paymentMethod" class="w-full p-3 border rounded-lg">
                        <!-- Options will be loaded dynamically -->
                    </select>
                </div>
                <button onclick="proceedToCheckout()" class="w-full gradient-btn text-white py-3 rounded-lg font-semibold">
                    <i class="fas fa-shopping-cart mr-2"></i>
                    Confirmar Pedido
                </button>
            </div>
        </div>
    </div>

    <!-- Checkout Modal -->
    <div id="checkoutModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-purple-800">Datos de Entrega</h2>
                <button onclick="closeCheckout()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <form id="checkoutForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Nombre completo:</label>
                    <input type="text" id="customerName" required class="w-full p-3 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Dirección:</label>
                    <input type="text" id="customerAddress" required class="w-full p-3 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Barrio:</label>
                    <input type="text" id="customerNeighborhood" required class="w-full p-3 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Teléfono:</label>
                    <input type="tel" id="customerPhone" required class="w-full p-3 border rounded-lg">
                </div>
                <button type="submit" class="w-full gradient-btn text-white py-3 rounded-lg font-semibold">
                    <i class="fas fa-check mr-2"></i>
                    Confirmar Datos de Entrega
                </button>
            </form>
        </div>
    </div>

    <!-- Product Details Modal -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 id="productTitle" class="text-2xl font-bold text-purple-800"></h2>
                <button onclick="closeProductModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="productDetails">
                <!-- Product details will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Review Modal -->
    <div id="reviewModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-purple-800">Dejar Reseña</h2>
                <button onclick="closeReviewModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <form id="reviewForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Nombre completo:</label>
                    <input type="text" id="reviewerName" required class="w-full p-3 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Teléfono:</label>
                    <input type="tel" id="reviewerPhone" required class="w-full p-3 border rounded-lg">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Correo electrónico:</label>
                    <input type="email" id="reviewerEmail" required class="w-full p-3 border rounded-lg">
                </div>
                <div>
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" id="dataConsent" required class="rounded">
                        <span class="text-sm">Autorizo el tratamiento de datos para promociones y noticias</span>
                    </label>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Calificación:</label>
                    <div class="star-rating" id="starRating">
                        <span class="star" data-rating="1">★</span>
                        <span class="star" data-rating="2">★</span>
                        <span class="star" data-rating="3">★</span>
                        <span class="star" data-rating="4">★</span>
                        <span class="star" data-rating="5">★</span>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-2">Comentario:</label>
                    <textarea id="reviewComment" rows="4" class="w-full p-3 border rounded-lg"></textarea>
                </div>
                <button type="submit" class="w-full gradient-btn text-white py-3 rounded-lg font-semibold">
                    Enviar Reseña
                </button>
            </form>
        </div>
    </div>

    <!-- Admin Login Modal -->
    <div id="adminLoginModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-purple-800">Acceso Administrativo</h2>
                <button onclick="closeAdminLogin()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <form id="adminLoginForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-2">Contraseña:</label>
                    <input type="password" id="adminPassword" required class="w-full p-3 border rounded-lg">
                </div>
                <button type="submit" class="w-full gradient-btn text-white py-3 rounded-lg font-semibold">
                    Ingresar
                </button>
            </form>
        </div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="modal admin-panel-modal">
        <div class="modal-content" style="max-width: 1200px;">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-purple-800">Panel Administrativo</h2>
                <button onclick="closeAdminPanel()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <button onclick="showAdminSection('products')" class="gradient-btn text-white p-4 rounded-lg font-semibold">
                    <i class="fas fa-box mr-2"></i>Gestionar Productos
                </button>
                <button onclick="showAdminSection('categories')" class="gradient-btn text-white p-4 rounded-lg font-semibold">
                    <i class="fas fa-tags mr-2"></i>Gestionar Categorías
                </button>
                <button onclick="showAdminSection('logo')" class="gradient-btn text-white p-4 rounded-lg font-semibold">
                    <i class="fas fa-image mr-2"></i>Configurar Logo
                </button>
                <button onclick="showAdminSection('branding')" class="gradient-btn text-white p-4 rounded-lg font-semibold">
                    <i class="fas fa-edit mr-2"></i>Editar Nombre Tienda
                </button>
                <button onclick="showAdminSection('payments')" class="gradient-btn text-white p-4 rounded-lg font-semibold">
                    <i class="fas fa-credit-card mr-2"></i>Medios de Pago
                </button>
                <button onclick="showAdminSection('customers')" class="gradient-btn text-white p-4 rounded-lg font-semibold">
                    <i class="fas fa-users mr-2"></i>Base de Datos
                </button>
                <button onclick="showAdminSection('reviews')" class="gradient-btn text-white p-4 rounded-lg font-semibold">
                    <i class="fas fa-star mr-2"></i>Gestionar Reseñas
                </button>
            </div>
            
            <div id="adminContent">
                <!-- Admin content will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Order Confirmation Modal -->
    <div id="orderConfirmationModal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-purple-800">Confirmar Pedido</h2>
                <button onclick="closeOrderConfirmation()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div id="orderSummary" class="mb-6">
                <!-- Order summary will be displayed here -->
            </div>
            <div class="bg-green-50 border border-green-200 rounded-lg p-4 mb-6">
                <div class="flex items-center mb-2">
                    <i class="fas fa-info-circle text-green-600 mr-2"></i>
                    <span class="font-semibold text-green-800">¡Tu pedido está listo!</span>
                </div>
                <p class="text-green-700 text-sm">
                    Al enviar por WhatsApp, nuestro equipo recibirá todos los detalles de tu pedido y se pondrá en contacto contigo para coordinar la entrega.
                </p>
            </div>
            <button onclick="sendOrderToWhatsApp()" class="w-full bg-green-500 hover:bg-green-600 text-white py-4 rounded-lg font-semibold text-lg">
                <i class="fab fa-whatsapp mr-2"></i>
                Enviar Pedido por WhatsApp
            </button>
        </div>
    </div>

    <!-- WhatsApp Button -->
    <a href="https://wa.me/573150646191" target="_blank" class="whatsapp-btn w-16 h-16 rounded-full flex items-center justify-center text-white text-2xl shadow-lg">
        <i class="fab fa-whatsapp"></i>
    </a>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-app.js";
        import { getDatabase, ref, set, get, onValue, push, remove, update } from "https://www.gstatic.com/firebasejs/12.2.1/firebase-database.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCaXrYAaMtVFwgY-548nmM62SpGLhJuE9M",
            authDomain: "lamorenasmokeshop-digital.firebaseapp.com",
            databaseURL: "https://lamorenasmokeshop-digital-default-rtdb.firebaseio.com",
            projectId: "lamorenasmokeshop-digital",
            storageBucket: "lamorenasmokeshop-digital.firebasestorage.app",
            messagingSenderId: "403031380570",
            appId: "1:403031380570:web:b3efd17ec74db863583e63",
            measurementId: "G-WDX2FLE7SH"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Make Firebase functions globally available
        window.firebaseDB = {
            database,
            ref,
            set,
            get,
            onValue,
            push,
            remove,
            update
        };

        // Initialize the app once Firebase is ready
        window.initializeFirebaseApp();
    </script>

    <script>
        // Global variables
        let cart = [];
        let products = [];
        let categories = [];
        let customers = [];
        let reviews = [];
        let paymentMethods = [];
        let customerHistory = {};
        let productStats = {};
        let currentRating = 0;
        let currentProductId = null;
        let isAdmin = false;

        // Firebase initialization function
        window.initializeFirebaseApp = function() {
            console.log('🔥 Firebase conectado exitosamente');
            showSyncIndicator('Conectando...', false);
            
            // Initialize data and set up real-time listeners
            initializeFirebaseData();
            setupRealtimeListeners();
            
            setTimeout(() => {
                showSyncIndicator('Sincronizado', true);
                setTimeout(() => hideSyncIndicator(), 2000);
            }, 1000);
        };

        // Initialize Firebase data
        function initializeFirebaseData() {
            loadFirebaseData();
        }

        // Load data from Firebase
        async function loadFirebaseData() {
            try {
                const { database, ref, get } = window.firebaseDB;
                
                // Load categories
                const categoriesSnapshot = await get(ref(database, 'categories'));
                if (categoriesSnapshot.exists()) {
                    categories = Object.entries(categoriesSnapshot.val()).map(([key, value]) => ({
                        ...value,
                        firebaseKey: key
                    }));
                } else {
                    await initializeDefaultCategories();
                }

                // Load products
                const productsSnapshot = await get(ref(database, 'products'));
                if (productsSnapshot.exists()) {
                    products = Object.entries(productsSnapshot.val()).map(([key, value]) => ({
                        ...value,
                        firebaseKey: key
                    }));
                } else {
                    await initializeDefaultProducts();
                }

                // Load payment methods
                const paymentSnapshot = await get(ref(database, 'paymentMethods'));
                if (paymentSnapshot.exists()) {
                    paymentMethods = Object.entries(paymentSnapshot.val()).map(([key, value]) => ({
                        ...value,
                        firebaseKey: key
                    }));
                } else {
                    await initializeDefaultPaymentMethods();
                }

                // Load reviews
                const reviewsSnapshot = await get(ref(database, 'reviews'));
                if (reviewsSnapshot.exists()) {
                    reviews = Object.entries(reviewsSnapshot.val()).map(([key, value]) => ({
                        ...value,
                        firebaseKey: key
                    }));
                }

                // Load customers (orders)
                const customersSnapshot = await get(ref(database, 'orders'));
                if (customersSnapshot.exists()) {
                    customers = Object.entries(customersSnapshot.val()).map(([key, value]) => ({
                        ...value,
                        firebaseKey: key
                    }));
                }
                
                // Also load from old customers table for backward compatibility
                const oldCustomersSnapshot = await get(ref(database, 'customers'));
                if (oldCustomersSnapshot.exists()) {
                    const oldCustomers = Object.entries(oldCustomersSnapshot.val()).map(([key, value]) => ({
                        ...value,
                        firebaseKey: key
                    }));
                    customers = [...customers, ...oldCustomers];
                }

                // Load shop settings
                const settingsSnapshot = await get(ref(database, 'settings'));
                if (settingsSnapshot.exists()) {
                    const settings = settingsSnapshot.val();
                    if (settings.shopTitle) {
                        document.getElementById('shopTitle').textContent = settings.shopTitle;
                        document.title = settings.shopTitle + ' - Catálogo Digital';
                    }
                    if (settings.logo) {
                        const logoDisplay = document.getElementById('logoDisplay');
                        if (settings.logoPosition === 'header') {
                            logoDisplay.innerHTML = `<img src="${settings.logo}" alt="Logo" class="w-full h-full object-cover rounded-full border-2 border-white shadow-lg">`;
                        }
                    }
                }

                // Load and display data
                loadCategories();
                loadProducts();
                
            } catch (error) {
                console.error('Error loading Firebase data:', error);
                showSyncIndicator('Error de conexión', false);
            }
        }

        // Setup real-time listeners
        function setupRealtimeListeners() {
            const { database, ref, onValue } = window.firebaseDB;

            // Listen for categories changes
            onValue(ref(database, 'categories'), (snapshot) => {
                if (snapshot.exists()) {
                    categories = Object.entries(snapshot.val()).map(([key, value]) => ({
                        ...value,
                        firebaseKey: key
                    }));
                    loadCategories();
                }
            });

            // Listen for products changes
            onValue(ref(database, 'products'), (snapshot) => {
                if (snapshot.exists()) {
                    products = Object.entries(snapshot.val()).map(([key, value]) => ({
                        ...value,
                        firebaseKey: key
                    }));
                    loadProducts();
                }
            });

            // Listen for reviews changes
            onValue(ref(database, 'reviews'), (snapshot) => {
                if (snapshot.exists()) {
                    reviews = Object.entries(snapshot.val()).map(([key, value]) => ({
                        ...value,
                        firebaseKey: key
                    }));
                    loadProducts();
                }
            });

            // Listen for settings changes
            onValue(ref(database, 'settings'), (snapshot) => {
                if (snapshot.exists()) {
                    const settings = snapshot.val();
                    if (settings.shopTitle) {
                        document.getElementById('shopTitle').textContent = settings.shopTitle;
                        document.title = settings.shopTitle + ' - Catálogo Digital';
                    }
                    if (settings.logo) {
                        const logoDisplay = document.getElementById('logoDisplay');
                        if (settings.logoPosition === 'header') {
                            logoDisplay.innerHTML = `<img src="${settings.logo}" alt="Logo" class="w-full h-full object-cover rounded-full border-2 border-white shadow-lg">`;
                        }
                    }
                }
            });
        }

        // Initialize default data in Firebase
        async function initializeDefaultCategories() {
            const { database, ref, set } = window.firebaseDB;
            const defaultCategories = [
                { id: 1, name: 'Papeles, Cueros, Wraps y Tabaco', icon: '🚬' },
                { id: 2, name: 'Encendedores', icon: '🔥' },
                { id: 3, name: 'Pipas', icon: '🪈' },
                { id: 4, name: 'Grinders', icon: '⚙️' },
                { id: 5, name: 'Bongs', icon: '🫧' },
                { id: 6, name: 'Bandejas', icon: '🍽️' },
                { id: 7, name: 'Dispositivos Electrónicos y Vapes', icon: '💨' },
                { id: 8, name: 'Vidrio', icon: '🔮' },
                { id: 9, name: 'Premium', icon: '💎' },
                { id: 10, name: 'Zona Rosa', icon: '🌸' },
                { id: 11, name: 'Productos Exclusivos', icon: '⭐' }
            ];

            for (const category of defaultCategories) {
                await set(ref(database, `categories/${category.id}`), category);
            }
            categories = defaultCategories;
        }

        async function initializeDefaultProducts() {
            const { database, ref, set } = window.firebaseDB;
            const defaultProducts = [
                { id: 1, name: 'Papel Premium OCB', price: 15000, category: 1, description: 'Papeles de alta calidad para una experiencia premium', image: '📄' },
                { id: 2, name: 'Encendedor Zippo Edición Limitada', price: 85000, category: 2, description: 'Encendedor de colección con diseño exclusivo', image: '🔥' },
                { id: 3, name: 'Pipa Artesanal de Madera', price: 120000, category: 3, description: 'Pipa tallada a mano con acabados premium', image: '🪈' },
                { id: 4, name: 'Grinder Metálico 4 Piezas', price: 45000, category: 4, description: 'Grinder de aluminio con compartimentos', image: '⚙️' },
                { id: 5, name: 'Bong de Vidrio Borosilicato', price: 180000, category: 5, description: 'Bong de vidrio resistente con diseño elegante', image: '🫧' },
                { id: 6, name: 'Bandeja Rolling Magnética', price: 35000, category: 6, description: 'Bandeja con superficie magnética antideslizante', image: '🍽️' },
                { id: 7, name: 'Vape Pen Premium', price: 250000, category: 7, description: 'Vaporizador de última generación', image: '💨' },
                { id: 8, name: 'Set de Vidrio Premium', price: 320000, category: 8, description: 'Conjunto completo de accesorios de vidrio', image: '🔮' },
                { id: 9, name: 'Kit Premium Completo', price: 450000, category: 9, description: 'Kit exclusivo con todos los accesorios premium', image: '💎' },
                { id: 10, name: 'Colección Zona Rosa', price: 95000, category: 10, description: 'Accesorios con diseño femenino y elegante', image: '🌸' },
                { id: 11, name: 'Edición Limitada Gold', price: 580000, category: 11, description: 'Producto exclusivo de edición limitada con acabados dorados', image: '🏆' }
            ];

            for (const product of defaultProducts) {
                await set(ref(database, `products/${product.id}`), product);
            }
            products = defaultProducts;
        }

        async function initializeDefaultPaymentMethods() {
            const { database, ref, set } = window.firebaseDB;
            const defaultMethods = [
                { id: 1, name: 'Efectivo', enabled: true },
                { id: 2, name: 'Transferencia', enabled: true },
                { id: 3, name: 'Link Datáfono Bold', enabled: true }
            ];

            for (const method of defaultMethods) {
                await set(ref(database, `paymentMethods/${method.id}`), method);
            }
            paymentMethods = defaultMethods;
        }

        // Sync indicator functions
        function showSyncIndicator(text, isSuccess) {
            const indicator = document.getElementById('syncIndicator');
            const textElement = document.getElementById('syncText');
            
            textElement.textContent = text;
            indicator.className = `sync-indicator ${isSuccess ? '' : 'offline'}`;
            indicator.style.display = 'block';
        }

        function hideSyncIndicator() {
            const indicator = document.getElementById('syncIndicator');
            indicator.style.display = 'none';
        }

        // Firebase CRUD operations
        async function saveProductToFirebase(product) {
            try {
                const { database, ref, set } = window.firebaseDB;
                await set(ref(database, `products/${product.id}`), product);
                showSyncIndicator('Producto guardado', true);
                setTimeout(() => hideSyncIndicator(), 2000);
            } catch (error) {
                console.error('Error saving product:', error);
                showSyncIndicator('Error al guardar', false);
            }
        }

        async function saveSettingsToFirebase(settings) {
            try {
                const { database, ref, update } = window.firebaseDB;
                await update(ref(database, 'settings'), settings);
                showSyncIndicator('Configuración guardada', true);
                setTimeout(() => hideSyncIndicator(), 2000);
            } catch (error) {
                console.error('Error saving settings:', error);
                showSyncIndicator('Error al guardar', false);
            }
        }

        // Format price with Colombian peso
        function formatPrice(price) {
            return '$' + price.toLocaleString('es-CO');
        }

        // Load categories
        function loadCategories() {
            const grid = document.getElementById('categoriesGrid');
            grid.innerHTML = categories.map(category => `
                <div class="premium-card p-6 rounded-xl text-center cursor-pointer" onclick="filterByCategory(${category.id})">
                    <div class="text-4xl mb-3">${category.icon}</div>
                    <h3 class="font-semibold text-purple-800 text-sm">${category.name}</h3>
                </div>
            `).join('');
        }

        // Load products
        function loadProducts(categoryFilter = null) {
            const grid = document.getElementById('productsGrid');
            const filteredProducts = categoryFilter ? 
                products.filter(p => p.category === categoryFilter) : products;

            grid.innerHTML = filteredProducts.map(product => {
                const imageDisplay = product.image && product.image.startsWith('data:') ? 
                    `<img src="${product.image}" alt="${product.name}" class="w-full h-40 object-cover rounded-lg mb-4 border-2 border-purple-200 cursor-pointer" onclick="openProductDetails(${product.id})">` :
                    `<div class="text-6xl text-center mb-4 cursor-pointer" onclick="openProductDetails(${product.id})">${product.image || '📦'}</div>`;
                
                // Indicador de stock simple
                const stockIndicator = product.stock === 0 ? 
                    '<div class="absolute top-2 right-2 bg-red-500 text-white text-xs px-2 py-1 rounded-full">Agotado</div>' :
                    product.stock <= 5 && product.stock > 0 ? 
                    '<div class="absolute top-2 right-2 bg-orange-500 text-white text-xs px-2 py-1 rounded-full">Pocas</div>' : '';

                // Calificación promedio simple
                const productReviews = reviews.filter(r => r.productId === product.id && r.visible !== false);
                const averageRating = productReviews.length > 0 ? 
                    (productReviews.reduce((sum, r) => sum + r.rating, 0) / productReviews.length).toFixed(1) : null;
                
                const ratingDisplay = averageRating ? 
                    `<div class="flex items-center space-x-1 text-sm text-yellow-600 mb-2">
                        <i class="fas fa-star"></i>
                        <span>${averageRating}</span>
                        <span class="text-gray-400">(${productReviews.length})</span>
                    </div>` : '';

                return `
                    <div class="premium-card p-6 rounded-xl relative cursor-pointer hover:shadow-xl transition-all duration-300" onclick="openProductDetails(${product.id})">
                        ${stockIndicator}
                        ${imageDisplay}
                        <h3 class="font-bold text-lg text-purple-800 mb-2 line-clamp-2">${product.name}</h3>
                        ${ratingDisplay}
                        <div class="flex justify-between items-center mb-4">
                            <span class="text-2xl font-bold text-green-600">${formatPrice(product.price)}</span>
                            <div class="flex items-center space-x-1 text-purple-600">
                                <i class="fas fa-eye text-sm"></i>
                                <span class="text-xs">Ver más</span>
                            </div>
                        </div>
                        <div class="flex space-x-2" onclick="event.stopPropagation()">
                            <button onclick="addToCart(${product.id})" 
                                    class="flex-1 gradient-btn text-white py-3 rounded-lg font-semibold text-sm ${product.stock === 0 ? 'opacity-50 cursor-not-allowed' : ''}"
                                    ${product.stock === 0 ? 'disabled' : ''}>
                                <i class="fas fa-cart-plus mr-1"></i>${product.stock === 0 ? 'Agotado' : 'Agregar'}
                            </button>
                            <button onclick="openProductDetails(${product.id})" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-3 rounded-lg">
                                <i class="fas fa-info-circle"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Filter products by category
        function filterByCategory(categoryId) {
            const category = categories.find(c => c.id === categoryId);
            const categoryName = category ? category.name : 'Categoría';
            
            const productsTitle = document.querySelector('section h2');
            if (productsTitle) {
                productsTitle.innerHTML = `${category.icon} ${categoryName}`;
            }
            
            loadProducts(categoryId);
        }

        // Show all products
        function showAllProducts() {
            const productsTitle = document.querySelector('section h2');
            if (productsTitle) {
                productsTitle.innerHTML = 'Productos Exclusivos';
            }
            
            loadProducts();
        }

        // Add to cart
        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            const existingItem = cart.find(item => item.id === productId);
            
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cart.push({ ...product, quantity: 1 });
            }
            
            updateCartBadge();
            showNotification('Producto agregado al carrito');
        }

        // Update cart badge
        function updateCartBadge() {
            const badge = document.getElementById('cartBadge');
            const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);
            badge.textContent = totalItems;
        }

        // Open cart modal
        function openCart() {
            const modal = document.getElementById('cartModal');
            const cartItems = document.getElementById('cartItems');
            const cartTotal = document.getElementById('cartTotal');
            const paymentSelect = document.getElementById('paymentMethod');
            
            const enabledMethods = paymentMethods.filter(m => m.enabled);
            paymentSelect.innerHTML = enabledMethods.map(method => 
                `<option value="${method.name.toLowerCase()}">${method.name}</option>`
            ).join('');
            
            if (cart.length === 0) {
                cartItems.innerHTML = '<p class="text-center text-gray-500">Tu carrito está vacío</p>';
                cartTotal.textContent = '$0';
            } else {
                cartItems.innerHTML = cart.map(item => {
                    const imageDisplay = item.image && item.image.startsWith('data:') ? 
                        `<img src="${item.image}" alt="${item.name}" class="w-12 h-12 object-cover rounded-lg border-2 border-purple-200">` :
                        `<span class="text-2xl">${item.image || '📦'}</span>`;
                    
                    return `
                        <div class="flex justify-between items-center p-4 border-b">
                            <div class="flex items-center space-x-4">
                                ${imageDisplay}
                                <div>
                                    <h4 class="font-semibold">${item.name}</h4>
                                    <p class="text-sm text-gray-600">${formatPrice(item.price)} c/u</p>
                                </div>
                            </div>
                            <div class="flex items-center space-x-2">
                                <button onclick="updateQuantity(${item.id}, -1)" class="bg-gray-200 px-2 py-1 rounded">-</button>
                                <span class="px-3">${item.quantity}</span>
                                <button onclick="updateQuantity(${item.id}, 1)" class="bg-gray-200 px-2 py-1 rounded">+</button>
                                <button onclick="removeFromCart(${item.id})" class="text-red-500 ml-2">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
                
                const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                cartTotal.textContent = formatPrice(total);
            }
            
            modal.style.display = 'block';
        }

        // Close cart modal
        function closeCart() {
            document.getElementById('cartModal').style.display = 'none';
        }

        // Update quantity
        function updateQuantity(productId, change) {
            const item = cart.find(item => item.id === productId);
            if (item) {
                item.quantity += change;
                if (item.quantity <= 0) {
                    removeFromCart(productId);
                } else {
                    openCart();
                    updateCartBadge();
                }
            }
        }

        // Remove from cart
        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            openCart();
            updateCartBadge();
        }

        // Proceed to checkout
        function proceedToCheckout() {
            if (cart.length === 0) {
                alert('Tu carrito está vacío');
                return;
            }
            closeCart();
            document.getElementById('checkoutModal').style.display = 'block';
        }

        // Close checkout modal
        function closeCheckout() {
            document.getElementById('checkoutModal').style.display = 'none';
        }

        // Handle checkout form submission
        document.getElementById('checkoutForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Validar que todos los campos estén llenos
            const name = document.getElementById('customerName').value.trim();
            const address = document.getElementById('customerAddress').value.trim();
            const neighborhood = document.getElementById('customerNeighborhood').value.trim();
            const phone = document.getElementById('customerPhone').value.trim();
            const paymentMethod = document.getElementById('paymentMethod').value;
            
            if (!name || !address || !neighborhood || !phone || !paymentMethod) {
                showNotification('Por favor completa todos los campos');
                return;
            }
            
            if (cart.length === 0) {
                showNotification('Tu carrito está vacío');
                return;
            }
            
            const customer = {
                id: Date.now(),
                name: name,
                address: address,
                neighborhood: neighborhood,
                phone: phone,
                paymentMethod: paymentMethod,
                items: [...cart],
                total: cart.reduce((sum, item) => sum + (item.price * item.quantity), 0),
                date: new Date().toISOString(),
                orderNumber: generateOrderNumber(),
                status: 'pending'
            };
            
            try {
                showSyncIndicator('Guardando pedido...', false);
                
                const { database, ref, set } = window.firebaseDB;
                
                // 1. Guardar pedido principal
                await set(ref(database, `orders/${customer.id}`), customer);
                console.log('✅ Pedido guardado:', customer.id);
                
                // 2. Actualizar historial del cliente
                await updateCustomerHistory(customer);
                console.log('✅ Historial de cliente actualizado');
                
                // 3. Actualizar estadísticas de productos
                await updateProductStats(customer.items);
                console.log('✅ Estadísticas de productos actualizadas');
                
                // 4. Guardar análisis de compra
                await savePurchaseAnalytics(customer);
                console.log('✅ Análisis de compra guardado');
                
                // Actualizar array local
                customers.push(customer);
                
                // Cerrar modal de checkout ANTES de mostrar confirmación
                closeCheckout();
                
                // Mostrar confirmación con delay para asegurar que se cierre el anterior
                setTimeout(() => {
                    showOrderConfirmation(customer);
                }, 300);
                
                showSyncIndicator('¡Pedido guardado exitosamente!', true);
                setTimeout(() => hideSyncIndicator(), 3000);
                
            } catch (error) {
                console.error('❌ Error saving order:', error);
                showSyncIndicator('Error al guardar pedido', false);
                showNotification('Error al guardar el pedido. Por favor intenta nuevamente.');
            }
        });

        // Show order confirmation
        function showOrderConfirmation(customer) {
            // Asegurar que otros modales estén cerrados
            document.querySelectorAll('.modal').forEach(modal => {
                if (modal.id !== 'orderConfirmationModal') {
                    modal.style.display = 'none';
                }
            });
            
            const modal = document.getElementById('orderConfirmationModal');
            const summary = document.getElementById('orderSummary');
            
            // Asegurar z-index máximo
            modal.style.zIndex = '9999999';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.9)';
            modal.style.backdropFilter = 'blur(5px)';
            
            const itemsList = customer.items.map(item => {
                const imageDisplay = item.image && item.image.startsWith('data:') ? 
                    `<img src="${item.image}" alt="${item.name}" class="w-12 h-12 object-cover rounded-lg border-2 border-purple-200">` :
                    `<span class="text-2xl">${item.image || '📦'}</span>`;
                
                return `
                    <div class="flex justify-between items-center py-2 border-b">
                        <div class="flex items-center space-x-3">
                            ${imageDisplay}
                            <div>
                                <span class="font-semibold">${item.name}</span>
                                <div class="text-sm text-gray-600">x${item.quantity}</div>
                            </div>
                        </div>
                        <span class="font-semibold">${formatPrice(item.price * item.quantity)}</span>
                    </div>
                `;
            }).join('');
            
            summary.innerHTML = `
                <div class="bg-gray-50 p-4 rounded-lg mb-4">
                    <h3 class="font-bold text-lg mb-3 text-purple-800">Resumen del Pedido #${customer.orderNumber}</h3>
                    ${itemsList}
                    <div class="flex justify-between items-center pt-3 mt-3 border-t-2 border-purple-200">
                        <span class="text-xl font-bold">Total:</span>
                        <span class="text-2xl font-bold text-green-600">${formatPrice(customer.total)}</span>
                    </div>
                </div>
                
                <div class="bg-blue-50 p-4 rounded-lg mb-4">
                    <h3 class="font-bold text-lg mb-3 text-blue-800">Datos de Entrega</h3>
                    <div class="space-y-2 text-sm">
                        <div><span class="font-semibold">Nombre:</span> ${customer.name}</div>
                        <div><span class="font-semibold">Teléfono:</span> ${customer.phone}</div>
                        <div><span class="font-semibold">Dirección:</span> ${customer.address}</div>
                        <div><span class="font-semibold">Barrio:</span> ${customer.neighborhood}</div>
                        <div><span class="font-semibold">Método de pago:</span> ${customer.paymentMethod}</div>
                        <div><span class="font-semibold">Fecha:</span> ${new Date(customer.date).toLocaleString()}</div>
                    </div>
                </div>
            `;
            
            window.currentOrder = customer;
            modal.style.display = 'block';
            
            // Enfocar el modal para asegurar que esté en primer plano
            modal.focus();
            
            // Prevenir scroll del fondo
            document.body.style.overflow = 'hidden';
            
            console.log('✅ Modal de confirmación mostrado para pedido:', customer.orderNumber);
        }

        // Close order confirmation
        function closeOrderConfirmation() {
            const modal = document.getElementById('orderConfirmationModal');
            modal.style.display = 'none';
            
            // Restaurar scroll del fondo
            document.body.style.overflow = '';
            
            window.currentOrder = null;
            console.log('✅ Modal de confirmación cerrado');
        }

        // Send order to WhatsApp
        function sendOrderToWhatsApp() {
            if (!window.currentOrder) {
                showNotification('Error: No hay pedido para enviar');
                console.error('❌ No hay pedido actual para enviar');
                return;
            }
            
            const customer = window.currentOrder;
            console.log('📱 Enviando pedido a WhatsApp:', customer.orderNumber);
            
            const itemsList = customer.items.map(item => 
                `• ${item.name} x${item.quantity} - ${formatPrice(item.price * item.quantity)}`
            ).join('\n');
            
            const shopName = document.getElementById('shopTitle').textContent.trim();
            
            const message = `🛍️ *NUEVO PEDIDO - ${shopName.toUpperCase()}*\n\n` +
                `📋 *PEDIDO #${customer.orderNumber}*\n\n` +
                `👤 *CLIENTE:*\n` +
                `Nombre: ${customer.name}\n` +
                `Teléfono: ${customer.phone}\n\n` +
                `📍 *ENTREGA:*\n` +
                `Dirección: ${customer.address}\n` +
                `Barrio: ${customer.neighborhood}\n\n` +
                `🛒 *PRODUCTOS:*\n${itemsList}\n\n` +
                `💰 *TOTAL: ${formatPrice(customer.total)}*\n` +
                `💳 *Método de pago: ${customer.paymentMethod}*\n\n` +
                `📅 Fecha: ${new Date(customer.date).toLocaleDateString()} - ${new Date(customer.date).toLocaleTimeString()}\n\n` +
                `¡Pedido listo para despachar! 🚀`;
            
            const whatsappUrl = `https://wa.me/573150646191?text=${encodeURIComponent(message)}`;
            
            // Limpiar carrito y cerrar modales
            cart = [];
            updateCartBadge();
            closeOrderConfirmation();
            
            // Mostrar notificación de éxito
            showNotification('¡Pedido enviado exitosamente! Te contactaremos pronto.');
            
            // Abrir WhatsApp
            try {
                window.open(whatsappUrl, '_blank');
                console.log('✅ WhatsApp abierto exitosamente');
            } catch (error) {
                console.error('❌ Error abriendo WhatsApp:', error);
                // Fallback: copiar mensaje al portapapeles
                navigator.clipboard.writeText(message).then(() => {
                    showNotification('Mensaje copiado al portapapeles. Pégalo en WhatsApp manualmente.');
                }).catch(() => {
                    showNotification('Error al abrir WhatsApp. Por favor contacta manualmente.');
                });
            }
        }

        // Product details
        function openProductDetails(productId) {
            const product = products.find(p => p.id === productId);
            const modal = document.getElementById('productModal');
            const title = document.getElementById('productTitle');
            const details = document.getElementById('productDetails');
            
            title.textContent = product.name;
            
            const imageDisplay = product.image && product.image.startsWith('data:') ? 
                `<img src="${product.image}" alt="${product.name}" class="w-48 h-48 object-cover rounded-xl mx-auto mb-4 border-4 border-purple-200 shadow-lg">` :
                `<div class="text-8xl mb-4">${product.image || '📦'}</div>`;
            
            const stockInfo = product.stock !== null && product.stock !== undefined ? 
                `<div class="mb-4 p-3 rounded-lg ${product.stock === 0 ? 'bg-red-50 border border-red-200' : product.stock <= 5 ? 'bg-orange-50 border border-orange-200' : 'bg-green-50 border border-green-200'}">
                    <div class="flex items-center justify-center space-x-2">
                        <i class="fas fa-box ${product.stock === 0 ? 'text-red-600' : product.stock <= 5 ? 'text-orange-600' : 'text-green-600'}"></i>
                        <span class="font-semibold ${product.stock === 0 ? 'text-red-600' : product.stock <= 5 ? 'text-orange-600' : 'text-green-600'}">
                            ${product.stock === 0 ? 'Producto Agotado' : product.stock <= 5 ? `Pocas unidades (${product.stock} disponibles)` : `${product.stock} unidades disponibles`}
                        </span>
                    </div>
                </div>` : '';
            
            const skuInfo = product.sku ? 
                `<div class="text-center mb-4">
                    <span class="bg-gray-100 text-gray-600 px-3 py-1 rounded-full text-sm">
                        <i class="fas fa-barcode mr-1"></i>SKU: ${product.sku}
                    </span>
                </div>` : '';
            
            details.innerHTML = `
                <div class="text-center mb-6">
                    ${imageDisplay}
                    <h3 class="text-2xl font-bold text-purple-800 mb-2">${product.name}</h3>
                    ${skuInfo}
                    <p class="text-gray-600 mb-4 text-lg leading-relaxed">${product.description}</p>
                    <div class="text-4xl font-bold text-green-600 mb-4">${formatPrice(product.price)}</div>
                    ${stockInfo}
                </div>
                
                <div class="mb-6">
                    <h4 class="font-bold mb-4 text-lg">⭐ Reseñas de clientes:</h4>
                    <div id="productReviews" class="bg-gray-50 p-4 rounded-lg">
                        ${getProductReviews(productId)}
                    </div>
                </div>
                
                <div class="flex space-x-4">
                    <button onclick="addToCart(${productId})" 
                            class="flex-1 gradient-btn text-white py-4 rounded-lg font-semibold text-lg ${product.stock === 0 ? 'opacity-50 cursor-not-allowed' : ''}"
                            ${product.stock === 0 ? 'disabled' : ''}>
                        <i class="fas fa-cart-plus mr-2"></i>${product.stock === 0 ? 'Producto Agotado' : 'Agregar al Carrito'}
                    </button>
                    <button onclick="openReviewModal(${productId})" class="bg-yellow-500 hover:bg-yellow-600 text-white px-6 py-4 rounded-lg font-semibold text-lg">
                        <i class="fas fa-star mr-2"></i>Reseñar
                    </button>
                </div>
            `;
            
            modal.style.display = 'block';
        }

        // Close product modal
        function closeProductModal() {
            document.getElementById('productModal').style.display = 'none';
        }

        // Get product reviews
        function getProductReviews(productId) {
            const productReviews = reviews.filter(r => r.productId === productId && r.visible !== false);
            
            if (productReviews.length === 0) {
                return '<p class="text-gray-500 text-sm">No hay reseñas aún</p>';
            }
            
            return productReviews.map(review => `
                <div class="bg-gray-50 p-4 rounded-lg mb-3" id="review-${review.id}">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex-1">
                            <div class="flex items-center space-x-2 mb-1">
                                <span class="font-semibold text-sm">${review.name}</span>
                                <div class="flex text-yellow-400">
                                    ${'★'.repeat(review.rating)}${'☆'.repeat(5-review.rating)}
                                </div>
                                <span class="text-xs text-gray-400">${new Date(review.date).toLocaleDateString()}</span>
                            </div>
                            <p class="text-sm text-gray-600">${review.comment}</p>
                        </div>
                        <div class="flex space-x-1 ml-2">
                            <button onclick="editCustomerReview(${review.id})" class="text-blue-500 hover:text-blue-700 text-xs px-2 py-1 rounded border border-blue-300 hover:bg-blue-50" title="Editar mi reseña">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="deleteCustomerReview(${review.id})" class="text-red-500 hover:text-red-700 text-xs px-2 py-1 rounded border border-red-300 hover:bg-red-50" title="Eliminar mi reseña">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Open review modal
        function openReviewModal(productId) {
            currentProductId = productId;
            currentRating = 0;
            document.getElementById('reviewModal').style.display = 'block';
            updateStarDisplay();
        }

        // Close review modal
        function closeReviewModal() {
            document.getElementById('reviewModal').style.display = 'none';
            document.getElementById('reviewForm').reset();
            currentRating = 0;
            updateStarDisplay();
        }

        // Star rating functionality
        document.querySelectorAll('.star').forEach(star => {
            star.addEventListener('click', function() {
                currentRating = parseInt(this.dataset.rating);
                updateStarDisplay();
            });
        });

        function updateStarDisplay() {
            document.querySelectorAll('.star').forEach((star, index) => {
                if (index < currentRating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }

        // Handle review form submission
        document.getElementById('reviewForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (currentRating === 0) {
                alert('Por favor selecciona una calificación');
                return;
            }
            
            const review = {
                id: Date.now(),
                productId: currentProductId,
                name: document.getElementById('reviewerName').value,
                phone: document.getElementById('reviewerPhone').value,
                email: document.getElementById('reviewerEmail').value,
                rating: currentRating,
                comment: document.getElementById('reviewComment').value,
                date: new Date().toISOString(),
                visible: true
            };
            
            try {
                showSyncIndicator('Guardando reseña...', false);
                
                const { database, ref, set } = window.firebaseDB;
                
                // 1. Guardar reseña principal
                await set(ref(database, `reviews/${review.id}`), review);
                console.log('✅ Reseña guardada:', review.id);
                
                // 2. Actualizar historial de reseñas del cliente
                await updateCustomerReviewHistory(review);
                console.log('✅ Historial de reseñas actualizado');
                
                // 3. Actualizar estadísticas del producto
                await updateProductRatingStats(review);
                console.log('✅ Estadísticas de calificación actualizadas');
                
                // 4. Guardar análisis de satisfacción
                await saveSatisfactionAnalytics(review);
                console.log('✅ Análisis de satisfacción guardado');
                
                // Actualizar array local
                reviews.push(review);
                
                showNotification('¡Reseña enviada exitosamente!');
                closeReviewModal();
                
                loadProducts();
                
                if (document.getElementById('productModal').style.display === 'block') {
                    openProductDetails(currentProductId);
                }
                
                showSyncIndicator('¡Reseña guardada exitosamente!', true);
                setTimeout(() => hideSyncIndicator(), 3000);
                
            } catch (error) {
                console.error('❌ Error saving review:', error);
                showSyncIndicator('Error al guardar reseña', false);
                alert('Error al guardar la reseña. Por favor intenta nuevamente.');
            }
        });

        // Customer review management functions
        async function editCustomerReview(reviewId) {
            const review = reviews.find(r => r.id === reviewId);
            if (!review) {
                showNotification('Reseña no encontrada');
                return;
            }

            // Verificar identidad del cliente
            showPhoneVerificationModal(
                'Verificar Identidad',
                'Para editar tu reseña, ingresa tu número de teléfono:',
                review.phone,
                () => {
                    // Abrir modal de edición
                    showEditReviewModal(review);
                }
            );
        }

        async function deleteCustomerReview(reviewId) {
            const review = reviews.find(r => r.id === reviewId);
            if (!review) {
                showNotification('Reseña no encontrada');
                return;
            }

            // Verificar identidad del cliente
            showPhoneVerificationModal(
                'Verificar Identidad',
                'Para eliminar tu reseña, ingresa tu número de teléfono:',
                review.phone,
                () => {
                    showConfirmationModal(
                        '¿Eliminar Tu Reseña?',
                        '¿Estás seguro de eliminar tu reseña? Esta acción no se puede deshacer.',
                        async () => {
                            try {
                                const { database, ref, remove } = window.firebaseDB;
                                const firebaseKey = review.firebaseKey || reviewId;
                                await remove(ref(database, `reviews/${firebaseKey}`));
                                
                                // Actualizar array local
                                reviews = reviews.filter(r => r.id !== reviewId);
                                
                                // Recargar vistas
                                loadProducts();
                                if (document.getElementById('productModal').style.display === 'block') {
                                    openProductDetails(review.productId);
                                }
                                
                                showNotification('Tu reseña ha sido eliminada exitosamente');
                            } catch (error) {
                                console.error('Error eliminando reseña:', error);
                                showNotification('Error al eliminar la reseña');
                            }
                        }
                    );
                }
            );
        }

        function showEditReviewModal(review) {
            const modal = document.createElement('div');
            modal.className = 'modal customer-edit-modal';
            modal.style.display = 'block';
            modal.style.zIndex = '75000';
            
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-purple-800">Editar Mi Reseña</h2>
                        <button onclick="this.closest('.modal').remove()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                    </div>
                    <form id="editReviewForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Nombre completo:</label>
                            <input type="text" id="editReviewerName" value="${review.name}" required class="w-full p-3 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Teléfono:</label>
                            <input type="tel" id="editReviewerPhone" value="${review.phone}" required class="w-full p-3 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Correo electrónico:</label>
                            <input type="email" id="editReviewerEmail" value="${review.email}" required class="w-full p-3 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Calificación:</label>
                            <div class="star-rating" id="editStarRating">
                                <span class="star ${review.rating >= 1 ? 'active' : ''}" data-rating="1">★</span>
                                <span class="star ${review.rating >= 2 ? 'active' : ''}" data-rating="2">★</span>
                                <span class="star ${review.rating >= 3 ? 'active' : ''}" data-rating="3">★</span>
                                <span class="star ${review.rating >= 4 ? 'active' : ''}" data-rating="4">★</span>
                                <span class="star ${review.rating >= 5 ? 'active' : ''}" data-rating="5">★</span>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Comentario:</label>
                            <textarea id="editReviewComment" rows="4" class="w-full p-3 border rounded-lg">${review.comment}</textarea>
                        </div>
                        <div class="flex space-x-4">
                            <button type="submit" class="flex-1 gradient-btn text-white py-3 rounded-lg font-semibold">
                                Guardar Cambios
                            </button>
                            <button type="button" onclick="this.closest('.modal').remove()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg font-semibold">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            let editRating = review.rating;
            
            // Setup star rating for edit modal
            modal.querySelectorAll('.star').forEach(star => {
                star.addEventListener('click', function() {
                    editRating = parseInt(this.dataset.rating);
                    modal.querySelectorAll('.star').forEach((s, index) => {
                        if (index < editRating) {
                            s.classList.add('active');
                        } else {
                            s.classList.remove('active');
                        }
                    });
                });
            });
            
            // Handle form submission
            modal.querySelector('#editReviewForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                if (editRating === 0) {
                    alert('Por favor selecciona una calificación');
                    return;
                }
                
                const updatedReview = {
                    ...review,
                    name: document.getElementById('editReviewerName').value,
                    phone: document.getElementById('editReviewerPhone').value,
                    email: document.getElementById('editReviewerEmail').value,
                    rating: editRating,
                    comment: document.getElementById('editReviewComment').value,
                    lastModified: new Date().toISOString()
                };
                
                try {
                    // Save to Firebase
                    const { database, ref, set } = window.firebaseDB;
                    const firebaseKey = review.firebaseKey || review.id;
                    await set(ref(database, `reviews/${firebaseKey}`), updatedReview);
                    
                    // Update local array
                    const index = reviews.findIndex(r => r.id === review.id);
                    if (index !== -1) {
                        reviews[index] = updatedReview;
                    }
                    
                    // Reload views
                    loadProducts();
                    if (document.getElementById('productModal').style.display === 'block') {
                        openProductDetails(review.productId);
                    }
                    
                    modal.remove();
                    showNotification('Tu reseña ha sido actualizada exitosamente');
                } catch (error) {
                    console.error('Error actualizando reseña:', error);
                    showNotification('Error al actualizar la reseña');
                }
            });
        }

        // Admin functionality
        function openAdminLogin() {
            document.getElementById('adminLoginModal').style.display = 'block';
        }

        function closeAdminLogin() {
            document.getElementById('adminLoginModal').style.display = 'none';
        }

        // Handle admin login
        document.getElementById('adminLoginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const password = document.getElementById('adminPassword').value;
            if (password === 'Lamorena04191106') {
                isAdmin = true;
                closeAdminLogin();
                document.getElementById('adminPanel').style.display = 'block';
                showAdminSection('products');
            } else {
                alert('Contraseña incorrecta');
            }
        });

        function closeAdminPanel() {
            document.getElementById('adminPanel').style.display = 'none';
            isAdmin = false;
        }

        // Show admin sections
        function showAdminSection(section) {
            const content = document.getElementById('adminContent');
            
            switch(section) {
                case 'products':
                    content.innerHTML = `
                        <div class="bg-white p-6 rounded-lg">
                            <h3 class="text-xl font-bold mb-4">Gestionar Productos</h3>
                            <button onclick="addNewProduct()" class="gradient-btn text-white px-4 py-2 rounded-lg mb-4">
                                <i class="fas fa-plus mr-2"></i>Agregar Producto
                            </button>
                            <div class="overflow-x-auto">
                                <table class="w-full border-collapse border">
                                    <thead>
                                        <tr class="bg-gray-100">
                                            <th class="border p-2">Imagen</th>
                                            <th class="border p-2">Nombre</th>
                                            <th class="border p-2">Precio</th>
                                            <th class="border p-2">Stock</th>
                                            <th class="border p-2">SKU</th>
                                            <th class="border p-2">Categoría</th>
                                            <th class="border p-2">Acciones</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${products.map(product => {
                                            const imageDisplay = product.image && product.image.startsWith('data:') ? 
                                                `<img src="${product.image}" alt="${product.name}" class="w-12 h-12 object-cover rounded border">` :
                                                `<span class="text-2xl">${product.image || '📦'}</span>`;
                                            
                                            const stockStatus = product.stock === 0 ? 
                                                '<span class="text-red-600 font-semibold">Agotado</span>' :
                                                product.stock <= 5 && product.stock > 0 ?
                                                `<span class="text-orange-600">${product.stock} (Bajo)</span>` :
                                                product.stock || 'N/A';
                                            
                                            return `
                                                <tr class="${product.stock === 0 ? 'bg-red-50' : ''}">
                                                    <td class="border p-2 text-center">${imageDisplay}</td>
                                                    <td class="border p-2">
                                                        <div class="font-semibold">${product.name}</div>
                                                        ${product.sku ? `<div class="text-xs text-gray-500">SKU: ${product.sku}</div>` : ''}
                                                    </td>
                                                    <td class="border p-2 font-semibold">${formatPrice(product.price)}</td>
                                                    <td class="border p-2 text-center">${stockStatus}</td>
                                                    <td class="border p-2 text-center text-xs text-gray-600">${product.sku || '-'}</td>
                                                    <td class="border p-2">
                                                        <span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded">
                                                            ${categories.find(c => c.id === product.category)?.name || 'N/A'}
                                                        </span>
                                                    </td>
                                                    <td class="border p-2">
                                                        <div class="flex space-x-1">
                                                            <button onclick="editProduct(${product.id})" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs" title="Editar producto">
                                                                <i class="fas fa-edit"></i>
                                                            </button>
                                                            <button onclick="duplicateProduct(${product.id})" class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs" title="Duplicar producto">
                                                                <i class="fas fa-copy"></i>
                                                            </button>
                                                            <button onclick="deleteProduct(${product.id})" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs" title="Eliminar producto">
                                                                <i class="fas fa-trash"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'categories':
                    content.innerHTML = `
                        <div class="bg-white p-6 rounded-lg">
                            <h3 class="text-xl font-bold mb-4">Gestionar Categorías</h3>
                            <button onclick="addNewCategory()" class="gradient-btn text-white px-4 py-2 rounded-lg mb-4">
                                <i class="fas fa-plus mr-2"></i>Agregar Categoría
                            </button>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${categories.map(category => `
                                    <div class="border p-4 rounded-lg bg-gray-50">
                                        <div class="flex justify-between items-center">
                                            <div class="flex items-center">
                                                <span class="text-3xl mr-3">${category.icon}</span>
                                                <span class="font-semibold text-lg">${category.name}</span>
                                            </div>
                                            <div class="flex space-x-2">
                                                <button onclick="editCategory(${category.id})" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded text-sm">
                                                    <i class="fas fa-edit"></i> Editar
                                                </button>
                                                <button onclick="deleteCategory(${category.id})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded text-sm">
                                                    <i class="fas fa-trash"></i> Eliminar
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'logo':
                    content.innerHTML = `
                        <div class="bg-white p-6 rounded-lg">
                            <h3 class="text-xl font-bold mb-6">Configurar Logo</h3>
                            
                            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                                <h4 class="font-semibold mb-3">Vista Previa Actual:</h4>
                                <div class="flex items-center space-x-4">
                                    <div class="w-16 h-16 bg-gradient-to-r from-purple-800 to-purple-600 rounded-full flex items-center justify-center text-white font-bold text-xl border-2 border-white shadow-lg" id="previewLogo">
                                        PS
                                    </div>
                                    <span class="text-gray-600">Logo actual en el header</span>
                                </div>
                            </div>
                            
                            <div class="space-y-6">
                                <div>
                                    <label class="block text-sm font-medium mb-2">📁 Seleccionar Nueva Imagen:</label>
                                    <input type="file" id="logoUpload" accept="image/*" class="w-full p-3 border-2 border-dashed border-gray-300 rounded-lg hover:border-purple-400 transition-colors">
                                    <p class="text-xs text-gray-500 mt-1">Formatos: JPG, PNG, GIF | Tamaño máximo: 5MB</p>
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium mb-2">📍 Posición del Logo:</label>
                                    <select id="logoPosition" class="w-full p-3 border rounded-lg">
                                        <option value="header">🔝 Logo pequeño en header (recomendado)</option>
                                        <option value="background">🖼️ Fondo de pantalla (marca de agua)</option>
                                    </select>
                                </div>
                                
                                <div class="flex space-x-4">
                                    <button onclick="updateLogo()" class="flex-1 gradient-btn text-white py-3 px-6 rounded-lg font-semibold">
                                        <i class="fas fa-upload mr-2"></i>
                                        Actualizar Logo
                                    </button>
                                    <button onclick="resetLogo()" class="bg-gray-500 hover:bg-gray-600 text-white py-3 px-6 rounded-lg font-semibold">
                                        <i class="fas fa-undo mr-2"></i>
                                        Resetear
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'branding':
                    const currentTitle = document.getElementById('shopTitle').textContent.trim();
                    content.innerHTML = `
                        <div class="bg-white p-6 rounded-lg">
                            <h3 class="text-xl font-bold mb-6">✏️ Editar Nombre de la Tienda</h3>
                            
                            <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                                <h4 class="font-semibold mb-3">Vista Previa Actual:</h4>
                                <div class="flex items-center space-x-4">
                                    <h1 class="text-2xl font-bold bg-gradient-to-r from-purple-800 to-green-600 bg-clip-text text-transparent">
                                        ${currentTitle}
                                    </h1>
                                    <span class="text-gray-600">Nombre actual de la tienda</span>
                                </div>
                            </div>
                            
                            <form id="adminEditTitleForm" class="space-y-6">
                                <div>
                                    <label class="block text-sm font-medium mb-2">🏪 Nuevo nombre de la tienda:</label>
                                    <input type="text" id="adminNewShopTitle" value="${currentTitle}" required class="w-full p-4 border-2 rounded-lg text-lg font-semibold focus:border-purple-400 transition-colors" placeholder="Ingresa el nuevo nombre">
                                </div>
                                
                                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                                    <div class="flex items-start">
                                        <i class="fas fa-info-circle text-blue-600 mr-2 mt-1"></i>
                                        <div class="text-sm text-blue-800">
                                            <p class="font-semibold mb-1">💡 Vista previa en tiempo real:</p>
                                            <div class="bg-white p-3 rounded border mt-2">
                                                <span id="adminTitlePreview" class="text-xl font-bold bg-gradient-to-r from-purple-800 to-green-600 bg-clip-text text-transparent">
                                                    ${currentTitle}
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="flex space-x-4">
                                    <button type="submit" class="flex-1 gradient-btn text-white py-3 px-6 rounded-lg font-semibold">
                                        <i class="fas fa-save mr-2"></i>Guardar Cambios
                                    </button>
                                    <button type="button" onclick="resetShopTitle()" class="bg-gray-500 hover:bg-gray-600 text-white py-3 px-6 rounded-lg font-semibold">
                                        <i class="fas fa-undo mr-2"></i>Resetear a "Tu Smokeshop"
                                    </button>
                                </div>
                            </form>
                        </div>
                    `;
                    
                    setTimeout(() => {
                        const input = document.getElementById('adminNewShopTitle');
                        const preview = document.getElementById('adminTitlePreview');
                        
                        input.addEventListener('input', function() {
                            const value = this.value.trim();
                            preview.textContent = value || 'Tu Smokeshop';
                        });
                        
                        input.focus();
                        input.select();
                    }, 100);
                    break;
                    
                case 'payments':
                    content.innerHTML = `
                        <div class="bg-white p-6 rounded-lg">
                            <h3 class="text-xl font-bold mb-4">💳 Gestionar Medios de Pago</h3>
                            <button onclick="addNewPaymentMethod()" class="gradient-btn text-white px-4 py-2 rounded-lg mb-4">
                                <i class="fas fa-plus mr-2"></i>Agregar Método de Pago
                            </button>
                            <div class="space-y-4">
                                ${paymentMethods.map(method => `
                                    <div class="flex justify-between items-center p-4 border rounded-lg ${method.enabled ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}">
                                        <div class="flex items-center space-x-3">
                                            <span class="text-2xl">${method.enabled ? '✅' : '❌'}</span>
                                            <span class="font-semibold text-lg">${method.name}</span>
                                        </div>
                                        <div class="flex space-x-2">
                                            <button onclick="editPaymentMethod(${method.id})" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-2 rounded text-sm">
                                                <i class="fas fa-edit"></i> Editar
                                            </button>
                                            <button onclick="togglePaymentMethod(${method.id})" class="${method.enabled ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-500 hover:bg-green-600'} text-white px-3 py-2 rounded text-sm">
                                                <i class="fas fa-toggle-${method.enabled ? 'on' : 'off'}"></i>
                                                ${method.enabled ? 'Desactivar' : 'Activar'}
                                            </button>
                                            <button onclick="deletePaymentMethod(${method.id})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded text-sm">
                                                <i class="fas fa-trash"></i> Eliminar
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'customers':
                    content.innerHTML = `
                        <div class="bg-white p-6 rounded-lg">
                            <h3 class="text-xl font-bold mb-6">📊 Base de Datos y Análisis</h3>
                            
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                <div class="bg-blue-50 p-4 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-blue-600">${customers.length}</div>
                                    <div class="text-sm text-blue-800">Total Pedidos</div>
                                </div>
                                <div class="bg-green-50 p-4 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-green-600">${reviews.length}</div>
                                    <div class="text-sm text-green-800">Total Reseñas</div>
                                </div>
                                <div class="bg-purple-50 p-4 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-purple-600">${products.length}</div>
                                    <div class="text-sm text-purple-800">Productos Activos</div>
                                </div>
                                <div class="bg-yellow-50 p-4 rounded-lg text-center">
                                    <div class="text-2xl font-bold text-yellow-600">${formatPrice(customers.reduce((sum, c) => sum + c.total, 0))}</div>
                                    <div class="text-sm text-yellow-800">Ingresos Totales</div>
                                </div>
                            </div>
                            
                            <!-- Botones de exportación -->
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                                <button onclick="exportCustomerData()" class="bg-blue-500 hover:bg-blue-600 text-white p-4 rounded-lg font-semibold">
                                    <i class="fas fa-download mr-2"></i>📋 Historial de Clientes
                                    <div class="text-xs mt-1 opacity-80">Frecuencia, productos favoritos, satisfacción</div>
                                </button>
                                <button onclick="exportOrderData()" class="bg-green-500 hover:bg-green-600 text-white p-4 rounded-lg font-semibold">
                                    <i class="fas fa-download mr-2"></i>🛒 Todos los Pedidos
                                    <div class="text-xs mt-1 opacity-80">Pedidos completos con detalles</div>
                                </button>
                                <button onclick="exportProductStats()" class="bg-purple-500 hover:bg-purple-600 text-white p-4 rounded-lg font-semibold">
                                    <i class="fas fa-download mr-2"></i>📈 Estadísticas de Productos
                                    <div class="text-xs mt-1 opacity-80">Ventas, ingresos y calificaciones</div>
                                </button>
                                <button onclick="exportPurchaseAnalytics()" class="bg-orange-500 hover:bg-orange-600 text-white p-4 rounded-lg font-semibold">
                                    <i class="fas fa-download mr-2"></i>🔍 Análisis de Compras
                                    <div class="text-xs mt-1 opacity-80">Patrones de compra detallados</div>
                                </button>
                                <button onclick="exportSatisfactionAnalytics()" class="bg-pink-500 hover:bg-pink-600 text-white p-4 rounded-lg font-semibold">
                                    <i class="fas fa-download mr-2"></i>⭐ Análisis de Satisfacción
                                    <div class="text-xs mt-1 opacity-80">Reseñas y niveles de satisfacción</div>
                                </button>
                                <button onclick="exportCompleteAnalytics()" class="bg-indigo-500 hover:bg-indigo-600 text-white p-4 rounded-lg font-semibold">
                                    <i class="fas fa-download mr-2"></i>📊 Reporte Completo
                                    <div class="text-xs mt-1 opacity-80">Todos los datos en un archivo</div>
                                </button>
                            </div>
                            
                            <!-- Análisis rápido -->
                            <div class="bg-gray-50 p-4 rounded-lg mb-6">
                                <h4 class="font-bold mb-3">🔍 Análisis Rápido</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <strong>📱 Clientes únicos:</strong> <span id="uniqueCustomers">Calculando...</span>
                                    </div>
                                    <div>
                                        <strong>🔄 Clientes recurrentes:</strong> <span id="returningCustomers">Calculando...</span>
                                    </div>
                                    <div>
                                        <strong>💰 Ticket promedio:</strong> <span id="averageTicket">Calculando...</span>
                                    </div>
                                    <div>
                                        <strong>⭐ Calificación promedio:</strong> <span id="averageRating">Calculando...</span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Filtros de pedidos -->
                            <div class="bg-blue-50 p-4 rounded-lg mb-6">
                                <h4 class="font-bold mb-3">🔍 Filtrar Pedidos</h4>
                                <div class="flex flex-wrap gap-2">
                                    <button onclick="filterOrders('all')" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded-lg text-sm">
                                        📋 Todos (${customers.length})
                                    </button>
                                    <button onclick="filterOrders('pending')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-lg text-sm">
                                        ⏳ Pendientes (${customers.filter(c => c.status !== 'completed').length})
                                    </button>
                                    <button onclick="filterOrders('completed')" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg text-sm">
                                        ✅ Completados (${customers.filter(c => c.status === 'completed').length})
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Tabla de pedidos recientes -->
                            <div class="overflow-x-auto">
                                <h4 class="font-bold mb-3">📋 Gestión de Pedidos</h4>
                                <div id="ordersTable">
                                    ${generateOrdersTable(customers.slice(-20).reverse())}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Calcular estadísticas después de renderizar
                    setTimeout(() => {
                        calculateQuickStats();
                    }, 100);
                    break;
                    
                case 'reviews':
                    content.innerHTML = `
                        <div class="bg-white p-6 rounded-lg">
                            <h3 class="text-xl font-bold mb-4">Gestionar Reseñas</h3>
                            <div class="space-y-4">
                                ${reviews.length === 0 ? '<p class="text-gray-500 text-center py-8">No hay reseñas disponibles</p>' : 
                                reviews.map(review => `
                                    <div class="border p-4 rounded-lg ${review.visible === false ? 'bg-red-50 border-red-200' : 'bg-gray-50'}">
                                        <div class="flex justify-between items-start">
                                            <div class="flex-1">
                                                <div class="flex items-center space-x-3 mb-2">
                                                    <span class="font-semibold text-lg">${review.name}</span>
                                                    <div class="flex text-yellow-400 text-xl">
                                                        ${'★'.repeat(review.rating)}${'☆'.repeat(5-review.rating)}
                                                    </div>
                                                    <span class="text-sm text-gray-500 bg-white px-2 py-1 rounded">
                                                        ${products.find(p => p.id === review.productId)?.name || 'Producto eliminado'}
                                                    </span>
                                                </div>
                                                <p class="text-gray-700 mb-2">${review.comment}</p>
                                                <p class="text-xs text-gray-400">
                                                    ${new Date(review.date).toLocaleDateString()} - ${review.phone} - ${review.email}
                                                </p>
                                            </div>
                                            <div class="flex flex-col space-y-2 ml-4">
                                                <button onclick="toggleReviewVisibility(${review.id})" 
                                                        class="${review.visible !== false ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-500 hover:bg-green-600'} text-white px-3 py-2 rounded text-sm">
                                                    <i class="fas fa-eye${review.visible !== false ? '-slash' : ''}"></i>
                                                    ${review.visible !== false ? 'Ocultar' : 'Mostrar'}
                                                </button>
                                                <button onclick="deleteReview(${review.id})" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded text-sm">
                                                    <i class="fas fa-trash"></i> Eliminar
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                    break;
            }
        }

        // Admin functions
        function addNewProduct() {
            showProductModal('add');
        }

        function editProduct(id) {
            showProductModal('edit', id);
        }

        function duplicateProduct(id) {
            const originalProduct = products.find(p => p.id === id);
            if (!originalProduct) {
                showNotification('Producto no encontrado');
                return;
            }
            
            showConfirmationModal(
                '¿Duplicar Producto?',
                `¿Quieres crear una copia del producto "${originalProduct.name}"? Podrás editarlo después de crearlo.`,
                async () => {
                    try {
                        const duplicatedProduct = {
                            ...originalProduct,
                            id: Date.now(),
                            name: originalProduct.name + ' (Copia)',
                            sku: originalProduct.sku ? originalProduct.sku + '-COPY' : null,
                            lastUpdated: new Date().toISOString()
                        };
                        
                        showSyncIndicator('Duplicando producto...', false);
                        
                        await saveProductToFirebase(duplicatedProduct);
                        products.push(duplicatedProduct);
                        
                        loadProducts();
                        showAdminSection('products');
                        
                        showNotification('✅ Producto duplicado exitosamente');
                        showSyncIndicator('Producto duplicado', true);
                        setTimeout(() => hideSyncIndicator(), 2000);
                        
                    } catch (error) {
                        console.error('Error duplicating product:', error);
                        showNotification('❌ Error al duplicar producto');
                        showSyncIndicator('Error al duplicar', false);
                    }
                },
                'Duplicar',
                'fas fa-copy'
            );
        }

        async function deleteProduct(id) {
            try {
                const product = products.find(p => p.id === id);
                if (!product) {
                    showNotification('Producto no encontrado');
                    return;
                }
                
                showConfirmationModal(
                    '¿Eliminar Producto?',
                    `¿Estás seguro de eliminar el producto "${product.name}"? Esta acción no se puede deshacer.`,
                    async () => {
                        const { database, ref, remove } = window.firebaseDB;
                        
                        // Usar la clave de Firebase si existe, sino usar el ID
                        const firebaseKey = product.firebaseKey || id;
                        await remove(ref(database, `products/${firebaseKey}`));
                        
                        // Actualizar array local
                        products = products.filter(p => p.id !== id);
                        
                        // Recargar vista
                        loadProducts();
                        showAdminSection('products');
                        showNotification('Producto eliminado exitosamente');
                    }
                );
            } catch (error) {
                console.error('Error eliminando producto:', error);
                showNotification('Error al eliminar producto');
            }
        }

        function addNewCategory() {
            showCategoryModal('add');
        }

        function editCategory(id) {
            showCategoryModal('edit', id);
        }

        async function deleteCategory(id) {
            try {
                const category = categories.find(c => c.id === id);
                if (!category) {
                    showNotification('Categoría no encontrada');
                    return;
                }
                
                showConfirmationModal(
                    '¿Eliminar Categoría?',
                    `¿Estás seguro de eliminar la categoría "${category.name}"? Esta acción no se puede deshacer.`,
                    async () => {
                        const { database, ref, remove } = window.firebaseDB;
                        
                        // Usar la clave de Firebase si existe, sino usar el ID
                        const firebaseKey = category.firebaseKey || id;
                        await remove(ref(database, `categories/${firebaseKey}`));
                        
                        // Actualizar array local
                        categories = categories.filter(c => c.id !== id);
                        
                        // Recargar vista
                        loadCategories();
                        showAdminSection('categories');
                        showNotification('Categoría eliminada exitosamente');
                    }
                );
            } catch (error) {
                console.error('Error eliminando categoría:', error);
                showNotification('Error al eliminar categoría');
            }
        }

        async function togglePaymentMethod(id) {
            const method = paymentMethods.find(m => m.id === id);
            method.enabled = !method.enabled;
            
            const { database, ref, set } = window.firebaseDB;
            await set(ref(database, `paymentMethods/${id}`), method);
            
            showAdminSection('payments');
            showNotification(`Método de pago ${method.enabled ? 'activado' : 'desactivado'}`);
        }

        function addNewPaymentMethod() {
            showPaymentMethodModal('add');
        }

        function editPaymentMethod(id) {
            showPaymentMethodModal('edit', id);
        }

        async function deletePaymentMethod(id) {
            try {
                const method = paymentMethods.find(m => m.id === id);
                if (!method) {
                    showNotification('Método de pago no encontrado');
                    return;
                }
                
                showConfirmationModal(
                    '¿Eliminar Método de Pago?',
                    `¿Estás seguro de eliminar el método de pago "${method.name}"? Esta acción no se puede deshacer.`,
                    async () => {
                        const { database, ref, remove } = window.firebaseDB;
                        
                        // Usar la clave de Firebase si existe, sino usar el ID
                        const firebaseKey = method.firebaseKey || id;
                        await remove(ref(database, `paymentMethods/${firebaseKey}`));
                        
                        // Actualizar array local
                        paymentMethods = paymentMethods.filter(m => m.id !== id);
                        
                        // Recargar vista
                        showAdminSection('payments');
                        showNotification('Método de pago eliminado exitosamente');
                    }
                );
            } catch (error) {
                console.error('Error eliminando método de pago:', error);
                showNotification('Error al eliminar método de pago');
            }
        }

        async function toggleReviewVisibility(id) {
            try {
                const review = reviews.find(r => r.id === id);
                if (!review) {
                    showNotification('Reseña no encontrada');
                    return;
                }
                
                review.visible = review.visible !== false ? false : true;
                
                const { database, ref, set } = window.firebaseDB;
                const firebaseKey = review.firebaseKey || id;
                await set(ref(database, `reviews/${firebaseKey}`), review);
                
                loadProducts();
                showAdminSection('reviews');
                showNotification('Visibilidad de reseña actualizada');
            } catch (error) {
                console.error('Error actualizando reseña:', error);
                showNotification('Error al actualizar reseña');
            }
        }

        async function deleteReview(id) {
            try {
                const review = reviews.find(r => r.id === id);
                if (!review) {
                    showNotification('Reseña no encontrada');
                    return;
                }
                
                showConfirmationModal(
                    '¿Eliminar Reseña?',
                    `¿Estás seguro de eliminar esta reseña de ${review.name}? Esta acción no se puede deshacer.`,
                    async () => {
                        const { database, ref, remove } = window.firebaseDB;
                        const firebaseKey = review.firebaseKey || id;
                        await remove(ref(database, `reviews/${firebaseKey}`));
                        
                        // Actualizar array local
                        reviews = reviews.filter(r => r.id !== id);
                        
                        // Recargar vistas
                        loadProducts();
                        showAdminSection('reviews');
                        showNotification('Reseña eliminada exitosamente');
                    }
                );
            } catch (error) {
                console.error('Error eliminando reseña:', error);
                showNotification('Error al eliminar reseña');
            }
        }

        async function updateLogo() {
            const fileInput = document.getElementById('logoUpload');
            const position = document.getElementById('logoPosition').value;
            
            if (!fileInput.files || !fileInput.files[0]) {
                alert('Por favor selecciona un archivo de imagen');
                return;
            }
            
            const file = fileInput.files[0];
            
            if (!file.type.startsWith('image/')) {
                alert('Por favor selecciona un archivo de imagen válido');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                alert('El archivo es muy grande. Por favor selecciona una imagen menor a 5MB');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const logoDisplay = document.getElementById('logoDisplay');
                    const imageData = e.target.result;
                    
                    if (position === 'header') {
                        logoDisplay.innerHTML = `<img src="${imageData}" alt="Logo Premium Smokeshop" class="w-full h-full object-cover rounded-full border-2 border-white shadow-lg">`;
                        
                        await saveSettingsToFirebase({
                            logo: imageData,
                            logoPosition: 'header'
                        });
                        
                    } else if (position === 'background') {
                        const existingOverlay = document.getElementById('backgroundOverlay');
                        if (existingOverlay) {
                            existingOverlay.remove();
                        }
                        
                        const overlay = document.createElement('div');
                        overlay.id = 'backgroundOverlay';
                        overlay.style.cssText = `
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background-image: url(${imageData});
                            background-size: cover;
                            background-position: center;
                            background-attachment: fixed;
                            opacity: 0.1;
                            z-index: -1;
                            pointer-events: none;
                        `;
                        document.body.appendChild(overlay);
                        
                        await saveSettingsToFirebase({
                            logo: imageData,
                            logoPosition: 'background'
                        });
                    }
                    
                    showNotification('¡Logo actualizado exitosamente!');
                    
                } catch (error) {
                    console.error('Error al actualizar logo:', error);
                    alert('Error al procesar la imagen. Por favor intenta con otra imagen.');
                }
            };
            
            reader.readAsDataURL(file);
        }

        async function resetLogo() {
            if (confirm('¿Estás seguro de que quieres resetear el logo a su estado original?')) {
                const logoDisplay = document.getElementById('logoDisplay');
                logoDisplay.innerHTML = 'PS';
                
                const existingOverlay = document.getElementById('backgroundOverlay');
                if (existingOverlay) {
                    existingOverlay.remove();
                }
                
                await saveSettingsToFirebase({
                    logo: null,
                    logoPosition: null
                });
                
                showNotification('Logo reseteado exitosamente');
            }
        }

        async function resetShopTitle() {
            if (confirm('¿Estás seguro de resetear el nombre a "Tu Smokeshop"?')) {
                document.getElementById('shopTitle').textContent = 'Tu Smokeshop';
                document.title = 'Tu Smokeshop - Catálogo Digital';
                
                await saveSettingsToFirebase({
                    shopTitle: 'Tu Smokeshop'
                });
                
                showAdminSection('branding');
                showNotification('¡Nombre de la tienda reseteado exitosamente!');
            }
        }

        // Handle admin title form submission
        document.addEventListener('submit', async function(e) {
            if (e.target.id === 'adminEditTitleForm') {
                e.preventDefault();
                
                const newTitle = document.getElementById('adminNewShopTitle').value.trim();
                if (newTitle) {
                    document.getElementById('shopTitle').textContent = newTitle;
                    document.title = newTitle + ' - Catálogo Digital';
                    
                    await saveSettingsToFirebase({
                        shopTitle: newTitle
                    });
                    
                    showNotification('¡Nombre de la tienda actualizado exitosamente!');
                    
                    setTimeout(() => {
                        showAdminSection('branding');
                    }, 1000);
                }
            }
        });

        // Modal functions
        function showProductModal(action, productId = null) {
            const modal = document.createElement('div');
            modal.className = 'modal product-modal';
            modal.style.display = 'block';
            modal.style.zIndex = '70000';
            
            const product = productId ? products.find(p => p.id === productId) : null;
            const isEdit = action === 'edit';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 700px;">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-purple-800">${isEdit ? 'Editar' : 'Agregar'} Producto</h2>
                        <button onclick="this.closest('.modal').remove()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                    </div>
                    <form id="productForm" class="space-y-6">
                        <!-- Vista previa de imagen -->
                        <div class="bg-gray-50 p-6 rounded-lg text-center">
                            <h4 class="font-semibold mb-4">📸 Vista Previa del Producto</h4>
                            <div id="imagePreview" class="w-32 h-32 mx-auto mb-4 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center bg-white">
                                ${product && product.image ? 
                                    (product.image.startsWith('data:') ? 
                                        `<img src="${product.image}" alt="Producto" class="w-full h-full object-cover rounded-lg">` :
                                        `<span class="text-6xl">${product.image}</span>`
                                    ) : 
                                    '<span class="text-gray-400 text-sm">Sin imagen</span>'
                                }
                            </div>
                        </div>
                        
                        <!-- Información básica -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">📝 Nombre del producto:</label>
                                <input type="text" id="productName" value="${product ? product.name : ''}" required class="w-full p-3 border rounded-lg focus:border-purple-400">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">💰 Precio:</label>
                                <input type="number" id="productPrice" value="${product ? product.price : ''}" required class="w-full p-3 border rounded-lg focus:border-purple-400" min="0" step="1000">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">🏷️ Categoría:</label>
                            <select id="productCategory" required class="w-full p-3 border rounded-lg focus:border-purple-400">
                                ${categories.map(cat => 
                                    `<option value="${cat.id}" ${product && cat.id === product.category ? 'selected' : ''}>${cat.icon} ${cat.name}</option>`
                                ).join('')}
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-2">📄 Descripción:</label>
                            <textarea id="productDescription" required class="w-full p-3 border rounded-lg focus:border-purple-400" rows="3" placeholder="Describe las características del producto...">${product ? product.description : ''}</textarea>
                        </div>
                        
                        <!-- Opciones de imagen -->
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="font-semibold mb-4 text-blue-800">🖼️ Imagen del Producto</h4>
                            
                            <div class="space-y-4">
                                <!-- Subir foto -->
                                <div>
                                    <label class="block text-sm font-medium mb-2">📷 Subir Foto Real:</label>
                                    <input type="file" id="productPhotoUpload" accept="image/*" class="w-full p-3 border-2 border-dashed border-blue-300 rounded-lg hover:border-blue-400 transition-colors bg-white">
                                    <p class="text-xs text-blue-600 mt-1">Formatos: JPG, PNG, GIF | Tamaño máximo: 5MB</p>
                                </div>
                                
                                <div class="text-center text-gray-500 text-sm">- O -</div>
                                
                                <!-- Emoji alternativo -->
                                <div>
                                    <label class="block text-sm font-medium mb-2">😊 Emoji/Icono (alternativo):</label>
                                    <input type="text" id="productEmoji" value="${product && !product.image.startsWith('data:') ? product.image : ''}" class="w-full p-3 border rounded-lg focus:border-purple-400" placeholder="🚬 Ej: 🚬, 🔥, 🪈">
                                    <p class="text-xs text-gray-500 mt-1">Solo si no subes una foto real</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Información adicional -->
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h4 class="font-semibold mb-4 text-green-800">📊 Información Adicional (Opcional)</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">📦 Stock disponible:</label>
                                    <input type="number" id="productStock" value="${product ? product.stock || '' : ''}" class="w-full p-3 border rounded-lg focus:border-green-400" min="0" placeholder="Cantidad disponible">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">🏷️ SKU/Código:</label>
                                    <input type="text" id="productSku" value="${product ? product.sku || '' : ''}" class="w-full p-3 border rounded-lg focus:border-green-400" placeholder="Código del producto">
                                </div>
                            </div>
                        </div>
                        
                        <div class="flex space-x-4">
                            <button type="submit" class="flex-1 gradient-btn text-white py-4 rounded-lg font-semibold text-lg">
                                <i class="fas fa-save mr-2"></i>
                                ${isEdit ? 'Guardar Cambios' : 'Agregar Producto'}
                            </button>
                            <button type="button" onclick="this.closest('.modal').remove()" class="flex-1 bg-gray-500 text-white py-4 rounded-lg font-semibold text-lg">
                                <i class="fas fa-times mr-2"></i>
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Setup image preview functionality
            const photoUpload = modal.querySelector('#productPhotoUpload');
            const emojiInput = modal.querySelector('#productEmoji');
            const imagePreview = modal.querySelector('#imagePreview');
            let currentImageData = product ? product.image : null;
            
            // Handle photo upload
            photoUpload.addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    if (!file.type.startsWith('image/')) {
                        showNotification('Por favor selecciona un archivo de imagen válido');
                        return;
                    }
                    
                    if (file.size > 5 * 1024 * 1024) {
                        showNotification('La imagen es muy grande. Por favor selecciona una imagen menor a 5MB');
                        return;
                    }
                    
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        currentImageData = event.target.result;
                        imagePreview.innerHTML = `<img src="${currentImageData}" alt="Producto" class="w-full h-full object-cover rounded-lg">`;
                        emojiInput.value = ''; // Clear emoji when photo is uploaded
                        showNotification('📷 Foto cargada exitosamente');
                    };
                    reader.readAsDataURL(file);
                }
            });
            
            // Handle emoji input
            emojiInput.addEventListener('input', function(e) {
                const emoji = e.target.value.trim();
                if (emoji && !currentImageData?.startsWith('data:')) {
                    currentImageData = emoji;
                    imagePreview.innerHTML = `<span class="text-6xl">${emoji}</span>`;
                }
            });
            
            // Handle form submission
            modal.querySelector('#productForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Validate image
                if (!currentImageData && !emojiInput.value.trim()) {
                    showNotification('Por favor agrega una imagen o emoji para el producto');
                    return;
                }
                
                const finalImage = currentImageData || emojiInput.value.trim();
                
                const productData = {
                    id: product ? product.id : Date.now(),
                    name: document.getElementById('productName').value.trim(),
                    price: parseInt(document.getElementById('productPrice').value),
                    category: parseInt(document.getElementById('productCategory').value),
                    description: document.getElementById('productDescription').value.trim(),
                    image: finalImage,
                    stock: document.getElementById('productStock').value ? parseInt(document.getElementById('productStock').value) : null,
                    sku: document.getElementById('productSku').value.trim() || null,
                    lastUpdated: new Date().toISOString()
                };
                
                try {
                    showSyncIndicator('Guardando producto...', false);
                    
                    await saveProductToFirebase(productData);
                    
                    if (isEdit) {
                        const index = products.findIndex(p => p.id === productData.id);
                        if (index !== -1) {
                            products[index] = productData;
                        }
                    } else {
                        products.push(productData);
                    }
                    
                    loadProducts();
                    showAdminSection('products');
                    modal.remove();
                    
                    showNotification(`✅ Producto ${isEdit ? 'actualizado' : 'agregado'} exitosamente`);
                    showSyncIndicator('Producto guardado', true);
                    setTimeout(() => hideSyncIndicator(), 2000);
                    
                } catch (error) {
                    console.error('Error saving product:', error);
                    showNotification('❌ Error al guardar el producto');
                    showSyncIndicator('Error al guardar', false);
                }
            });
        }

        function showCategoryModal(action, categoryId = null) {
            const modal = document.createElement('div');
            modal.className = 'modal product-modal';
            modal.style.display = 'block';
            modal.style.zIndex = '70000';
            
            const category = categoryId ? categories.find(c => c.id === categoryId) : null;
            const isEdit = action === 'edit';
            
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-purple-800">${isEdit ? 'Editar' : 'Agregar'} Categoría</h2>
                        <button onclick="this.closest('.modal').remove()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                    </div>
                    <form id="categoryForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Nombre de la categoría:</label>
                            <input type="text" id="categoryName" value="${category ? category.name : ''}" required class="w-full p-3 border rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-2">Emoji/Icono:</label>
                            <input type="text" id="categoryIcon" value="${category ? category.icon : ''}" required class="w-full p-3 border rounded-lg" placeholder="🚬">
                        </div>
                        <div class="flex space-x-4">
                            <button type="submit" class="flex-1 gradient-btn text-white py-3 rounded-lg font-semibold">
                                ${isEdit ? 'Guardar Cambios' : 'Agregar Categoría'}
                            </button>
                            <button type="button" onclick="this.closest('.modal').remove()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg font-semibold">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Handle form submission
            modal.querySelector('#categoryForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const categoryData = {
                    id: category ? category.id : Date.now(),
                    name: document.getElementById('categoryName').value,
                    icon: document.getElementById('categoryIcon').value
                };
                
                const { database, ref, set } = window.firebaseDB;
                await set(ref(database, `categories/${categoryData.id}`), categoryData);
                
                if (isEdit) {
                    const index = categories.findIndex(c => c.id === categoryData.id);
                    categories[index] = categoryData;
                } else {
                    categories.push(categoryData);
                }
                
                loadCategories();
                showAdminSection('categories');
                modal.remove();
                showNotification(`Categoría ${isEdit ? 'actualizada' : 'agregada'} exitosamente`);
            });
        }

        function showPaymentMethodModal(action, methodId = null) {
            const modal = document.createElement('div');
            modal.className = 'modal product-modal';
            modal.style.display = 'block';
            modal.style.zIndex = '70000';
            
            const method = methodId ? paymentMethods.find(m => m.id === methodId) : null;
            const isEdit = action === 'edit';
            
            modal.innerHTML = `
                <div class="modal-content">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-purple-800">${isEdit ? 'Editar' : 'Agregar'} Método de Pago</h2>
                        <button onclick="this.closest('.modal').remove()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                    </div>
                    <form id="paymentMethodForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-2">Nombre del método de pago:</label>
                            <input type="text" id="paymentMethodName" value="${method ? method.name : ''}" required class="w-full p-3 border rounded-lg" placeholder="Ej: Nequi, Daviplata, Tarjeta de crédito">
                        </div>
                        <div>
                            <label class="flex items-center space-x-2">
                                <input type="checkbox" id="paymentMethodEnabled" ${method ? (method.enabled ? 'checked' : '') : 'checked'} class="rounded">
                                <span class="text-sm">Método activo (disponible para clientes)</span>
                            </label>
                        </div>
                        <div class="flex space-x-4">
                            <button type="submit" class="flex-1 gradient-btn text-white py-3 rounded-lg font-semibold">
                                ${isEdit ? 'Guardar Cambios' : 'Agregar Método'}
                            </button>
                            <button type="button" onclick="this.closest('.modal').remove()" class="flex-1 bg-gray-500 text-white py-3 rounded-lg font-semibold">
                                Cancelar
                            </button>
                        </div>
                    </form>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Handle form submission
            modal.querySelector('#paymentMethodForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const methodData = {
                    id: method ? method.id : Date.now(),
                    name: document.getElementById('paymentMethodName').value,
                    enabled: document.getElementById('paymentMethodEnabled').checked
                };
                
                try {
                    const { database, ref, set } = window.firebaseDB;
                    await set(ref(database, `paymentMethods/${methodData.id}`), methodData);
                    
                    if (isEdit) {
                        const index = paymentMethods.findIndex(m => m.id === methodData.id);
                        paymentMethods[index] = methodData;
                    } else {
                        paymentMethods.push(methodData);
                    }
                    
                    showAdminSection('payments');
                    modal.remove();
                    showNotification(`Método de pago ${isEdit ? 'actualizado' : 'agregado'} exitosamente`);
                } catch (error) {
                    console.error('Error guardando método de pago:', error);
                    showNotification('Error al guardar método de pago');
                }
            });
        }

        // Customer and product analytics functions
        async function updateCustomerHistory(order) {
            try {
                const { database, ref, get, set } = window.firebaseDB;
                const customerRef = ref(database, `customerHistory/${order.phone}`);
                const snapshot = await get(customerRef);
                
                let customerData = {
                    name: order.name,
                    phone: order.phone,
                    email: order.email || '',
                    address: order.address,
                    neighborhood: order.neighborhood,
                    totalOrders: 1,
                    totalSpent: order.total,
                    firstOrder: order.date,
                    lastOrder: order.date,
                    orders: [order.id],
                    favoriteProducts: {},
                    preferredPayment: order.paymentMethod,
                    purchaseFrequency: {
                        daily: 0,
                        weekly: 0,
                        monthly: 1
                    },
                    averageOrderValue: order.total,
                    lastUpdated: new Date().toISOString()
                };
                
                if (snapshot.exists()) {
                    const existing = snapshot.val();
                    const daysSinceLastOrder = Math.floor((new Date() - new Date(existing.lastOrder)) / (1000 * 60 * 60 * 24));
                    
                    customerData = {
                        ...existing,
                        name: order.name,
                        address: order.address,
                        neighborhood: order.neighborhood,
                        totalOrders: existing.totalOrders + 1,
                        totalSpent: existing.totalSpent + order.total,
                        lastOrder: order.date,
                        orders: [...(existing.orders || []), order.id],
                        favoriteProducts: existing.favoriteProducts || {},
                        preferredPayment: order.paymentMethod,
                        purchaseFrequency: {
                            daily: daysSinceLastOrder <= 1 ? (existing.purchaseFrequency?.daily || 0) + 1 : existing.purchaseFrequency?.daily || 0,
                            weekly: daysSinceLastOrder <= 7 ? (existing.purchaseFrequency?.weekly || 0) + 1 : existing.purchaseFrequency?.weekly || 0,
                            monthly: (existing.purchaseFrequency?.monthly || 0) + 1
                        },
                        averageOrderValue: Math.round((existing.totalSpent + order.total) / (existing.totalOrders + 1)),
                        lastUpdated: new Date().toISOString()
                    };
                }
                
                // Update favorite products with more details
                order.items.forEach(item => {
                    if (customerData.favoriteProducts[item.id]) {
                        customerData.favoriteProducts[item.id].quantity += item.quantity;
                        customerData.favoriteProducts[item.id].totalSpent += (item.price * item.quantity);
                        customerData.favoriteProducts[item.id].purchaseCount += 1;
                        customerData.favoriteProducts[item.id].lastPurchase = order.date;
                        customerData.favoriteProducts[item.id].averageQuantityPerOrder = Math.round(customerData.favoriteProducts[item.id].quantity / customerData.favoriteProducts[item.id].purchaseCount);
                    } else {
                        customerData.favoriteProducts[item.id] = {
                            name: item.name,
                            quantity: item.quantity,
                            totalSpent: item.price * item.quantity,
                            purchaseCount: 1,
                            lastPurchase: order.date,
                            firstPurchase: order.date,
                            averageQuantityPerOrder: item.quantity,
                            category: item.category || 'Sin categoría'
                        };
                    }
                });
                
                await set(customerRef, customerData);
                console.log('✅ Historial del cliente actualizado:', order.phone);
                
            } catch (error) {
                console.error('❌ Error updating customer history:', error);
                throw error;
            }
        }

        async function updateProductStats(items) {
            try {
                const { database, ref, get, set } = window.firebaseDB;
                
                for (const item of items) {
                    const productRef = ref(database, `productStats/${item.id}`);
                    const snapshot = await get(productRef);
                    
                    let stats = {
                        productId: item.id,
                        name: item.name,
                        totalSold: item.quantity,
                        totalRevenue: item.price * item.quantity,
                        orderCount: 1,
                        lastSold: new Date().toISOString(),
                        averageRating: 0,
                        reviewCount: 0
                    };
                    
                    if (snapshot.exists()) {
                        const existing = snapshot.val();
                        stats = {
                            ...existing,
                            name: item.name, // Update name in case it changed
                            totalSold: existing.totalSold + item.quantity,
                            totalRevenue: existing.totalRevenue + (item.price * item.quantity),
                            orderCount: existing.orderCount + 1,
                            lastSold: new Date().toISOString()
                        };
                    }
                    
                    await set(productRef, stats);
                }
                
            } catch (error) {
                console.error('Error updating product stats:', error);
            }
        }

        // Nuevas funciones analíticas mejoradas
        async function savePurchaseAnalytics(order) {
            try {
                const { database, ref, set } = window.firebaseDB;
                const analyticsRef = ref(database, `analytics/purchases/${order.id}`);
                
                const analytics = {
                    orderId: order.id,
                    customerId: order.phone,
                    customerName: order.name,
                    date: order.date,
                    total: order.total,
                    itemCount: order.items.reduce((sum, item) => sum + item.quantity, 0),
                    paymentMethod: order.paymentMethod,
                    neighborhood: order.neighborhood,
                    categories: [...new Set(order.items.map(item => item.category))],
                    products: order.items.map(item => ({
                        id: item.id,
                        name: item.name,
                        quantity: item.quantity,
                        price: item.price,
                        total: item.price * item.quantity,
                        category: item.category
                    })),
                    timestamp: Date.now()
                };
                
                await set(analyticsRef, analytics);
                console.log('✅ Análisis de compra guardado');
                
            } catch (error) {
                console.error('❌ Error saving purchase analytics:', error);
                throw error;
            }
        }

        async function saveSatisfactionAnalytics(review) {
            try {
                const { database, ref, set } = window.firebaseDB;
                const analyticsRef = ref(database, `analytics/satisfaction/${review.id}`);
                
                const analytics = {
                    reviewId: review.id,
                    customerId: review.phone,
                    customerName: review.name,
                    productId: review.productId,
                    rating: review.rating,
                    comment: review.comment,
                    date: review.date,
                    satisfactionLevel: review.rating >= 4 ? 'high' : review.rating >= 3 ? 'medium' : 'low',
                    timestamp: Date.now()
                };
                
                await set(analyticsRef, analytics);
                console.log('✅ Análisis de satisfacción guardado');
                
            } catch (error) {
                console.error('❌ Error saving satisfaction analytics:', error);
                throw error;
            }
        }

        async function updateProductRatingStats(review) {
            try {
                const { database, ref, get, set } = window.firebaseDB;
                const productRef = ref(database, `productStats/${review.productId}`);
                const snapshot = await get(productRef);
                
                let stats = {
                    productId: review.productId,
                    reviewCount: 1,
                    totalRating: review.rating,
                    averageRating: review.rating,
                    ratingDistribution: {
                        1: review.rating === 1 ? 1 : 0,
                        2: review.rating === 2 ? 1 : 0,
                        3: review.rating === 3 ? 1 : 0,
                        4: review.rating === 4 ? 1 : 0,
                        5: review.rating === 5 ? 1 : 0
                    },
                    lastReview: review.date,
                    lastUpdated: new Date().toISOString()
                };
                
                if (snapshot.exists()) {
                    const existing = snapshot.val();
                    const newReviewCount = (existing.reviewCount || 0) + 1;
                    const newTotalRating = (existing.totalRating || 0) + review.rating;
                    
                    stats = {
                        ...existing,
                        reviewCount: newReviewCount,
                        totalRating: newTotalRating,
                        averageRating: Math.round((newTotalRating / newReviewCount) * 10) / 10,
                        ratingDistribution: {
                            1: (existing.ratingDistribution?.[1] || 0) + (review.rating === 1 ? 1 : 0),
                            2: (existing.ratingDistribution?.[2] || 0) + (review.rating === 2 ? 1 : 0),
                            3: (existing.ratingDistribution?.[3] || 0) + (review.rating === 3 ? 1 : 0),
                            4: (existing.ratingDistribution?.[4] || 0) + (review.rating === 4 ? 1 : 0),
                            5: (existing.ratingDistribution?.[5] || 0) + (review.rating === 5 ? 1 : 0)
                        },
                        lastReview: review.date,
                        lastUpdated: new Date().toISOString()
                    };
                }
                
                await set(productRef, stats);
                console.log('✅ Estadísticas de calificación actualizadas');
                
            } catch (error) {
                console.error('❌ Error updating product rating stats:', error);
                throw error;
            }
        }

        async function updateCustomerReviewHistory(review) {
            try {
                const { database, ref, get, set } = window.firebaseDB;
                
                // Update customer review history
                const customerRef = ref(database, `customerHistory/${review.phone}`);
                const customerSnapshot = await get(customerRef);
                
                if (customerSnapshot.exists()) {
                    const customerData = customerSnapshot.val();
                    customerData.reviews = customerData.reviews || [];
                    customerData.reviews.push({
                        reviewId: review.id,
                        productId: review.productId,
                        rating: review.rating,
                        comment: review.comment,
                        date: review.date
                    });
                    
                    // Calcular satisfacción promedio del cliente
                    const totalRating = customerData.reviews.reduce((sum, r) => sum + r.rating, 0);
                    customerData.averageSatisfaction = Math.round((totalRating / customerData.reviews.length) * 10) / 10;
                    customerData.totalReviews = customerData.reviews.length;
                    customerData.lastReview = review.date;
                    
                    await set(customerRef, customerData);
                    console.log('✅ Historial de reseñas del cliente actualizado');
                }
                
            } catch (error) {
                console.error('❌ Error updating customer review history:', error);
                throw error;
            }
        }

        // Data export functions
        function exportCustomerData() {
            showDownloadModal('📋 Exportando Historial de Clientes', 'Preparando datos de clientes...', () => {
                const { database, ref, get } = window.firebaseDB;
                
                get(ref(database, 'customerHistory')).then((snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        const csvContent = generateCustomerCSV(data);
                        downloadCSV(csvContent, 'clientes_historial.csv');
                    } else {
                        showNotification('No hay datos de clientes para exportar');
                    }
                }).catch((error) => {
                    console.error('Error exporting customer data:', error);
                    showNotification('Error al exportar datos de clientes');
                });
            });
        }

        function exportOrderData() {
            showDownloadModal('🛒 Exportando Todos los Pedidos', 'Preparando datos de pedidos...', () => {
                const { database, ref, get } = window.firebaseDB;
                
                get(ref(database, 'orders')).then((snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        const csvContent = generateOrderCSV(data);
                        downloadCSV(csvContent, 'pedidos_completos.csv');
                    } else {
                        showNotification('No hay datos de pedidos para exportar');
                    }
                }).catch((error) => {
                    console.error('Error exporting order data:', error);
                    showNotification('Error al exportar datos de pedidos');
                });
            });
        }

        function exportProductStats() {
            showDownloadModal('📈 Exportando Estadísticas de Productos', 'Preparando estadísticas de productos...', () => {
                const { database, ref, get } = window.firebaseDB;
                
                get(ref(database, 'productStats')).then((snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        const csvContent = generateProductStatsCSV(data);
                        downloadCSV(csvContent, 'estadisticas_productos.csv');
                    } else {
                        showNotification('No hay estadísticas de productos para exportar');
                    }
                }).catch((error) => {
                    console.error('Error exporting product stats:', error);
                    showNotification('Error al exportar estadísticas de productos');
                });
            });
        }

        function generateCustomerCSV(data) {
            const headers = [
                'Teléfono', 'Nombre', 'Email', 'Dirección', 'Barrio', 
                'Total Pedidos', 'Total Gastado', 'Valor Promedio Pedido', 'Primer Pedido', 'Último Pedido',
                'Método de Pago Preferido', 'Frecuencia Compra Mensual', 'Frecuencia Compra Semanal', 'Frecuencia Compra Diaria',
                'Total Reseñas', 'Satisfacción Promedio', 'Última Reseña', 'Productos Favoritos (Top 5)',
                'Categorías Preferidas', 'Cliente Desde (Días)', 'Tipo de Cliente'
            ];
            
            let csv = headers.join(',') + '\n';
            
            Object.values(data).forEach(customer => {
                const favoriteProducts = Object.entries(customer.favoriteProducts || {})
                    .sort((a, b) => b[1].quantity - a[1].quantity)
                    .slice(0, 5)
                    .map(([id, product]) => `${product.name} (${product.quantity} unidades - ${formatPrice(product.totalSpent)})`)
                    .join('; ');
                
                const categories = Object.values(customer.favoriteProducts || {})
                    .map(product => product.category)
                    .filter((category, index, arr) => arr.indexOf(category) === index)
                    .join('; ');
                
                const daysSinceFirstOrder = Math.floor((new Date() - new Date(customer.firstOrder)) / (1000 * 60 * 60 * 24));
                const customerType = customer.totalOrders >= 10 ? 'VIP' : customer.totalOrders >= 5 ? 'Frecuente' : customer.totalOrders >= 2 ? 'Recurrente' : 'Nuevo';
                
                const row = [
                    customer.phone,
                    `"${customer.name}"`,
                    customer.email || '',
                    `"${customer.address}"`,
                    `"${customer.neighborhood}"`,
                    customer.totalOrders,
                    customer.totalSpent,
                    customer.averageOrderValue || Math.round(customer.totalSpent / customer.totalOrders),
                    new Date(customer.firstOrder).toLocaleDateString(),
                    new Date(customer.lastOrder).toLocaleDateString(),
                    customer.preferredPayment,
                    customer.purchaseFrequency?.monthly || 0,
                    customer.purchaseFrequency?.weekly || 0,
                    customer.purchaseFrequency?.daily || 0,
                    customer.totalReviews || 0,
                    customer.averageSatisfaction || 'Sin reseñas',
                    customer.lastReview ? new Date(customer.lastReview).toLocaleDateString() : 'Sin reseñas',
                    `"${favoriteProducts}"`,
                    `"${categories}"`,
                    daysSinceFirstOrder,
                    customerType
                ];
                
                csv += row.join(',') + '\n';
            });
            
            return csv;
        }

        function generateOrderCSV(data) {
            const headers = [
                'Número Pedido', 'Fecha', 'Cliente', 'Teléfono', 'Dirección', 
                'Barrio', 'Método Pago', 'Productos', 'Total', 'Estado'
            ];
            
            let csv = headers.join(',') + '\n';
            
            Object.values(data).forEach(order => {
                const products = order.items.map(item => 
                    `${item.name} x${item.quantity} ($${item.price})`
                ).join('; ');
                
                const row = [
                    order.orderNumber,
                    new Date(order.date).toLocaleDateString(),
                    `"${order.name}"`,
                    order.phone,
                    `"${order.address}"`,
                    `"${order.neighborhood}"`,
                    order.paymentMethod,
                    `"${products}"`,
                    order.total,
                    order.status || 'pending'
                ];
                
                csv += row.join(',') + '\n';
            });
            
            return csv;
        }

        function generateProductStatsCSV(data) {
            const headers = [
                'ID Producto', 'Nombre', 'Total Vendido', 'Ingresos Totales', 
                'Número de Pedidos', 'Última Venta', 'Calificación Promedio', 'Número de Reseñas'
            ];
            
            let csv = headers.join(',') + '\n';
            
            Object.values(data).forEach(stats => {
                const row = [
                    stats.productId,
                    `"${stats.name}"`,
                    stats.totalSold,
                    stats.totalRevenue,
                    stats.orderCount,
                    new Date(stats.lastSold).toLocaleDateString(),
                    stats.averageRating || 0,
                    stats.reviewCount || 0
                ];
                
                csv += row.join(',') + '\n';
            });
            
            return csv;
        }

        // Nuevas funciones de exportación analítica
        function exportPurchaseAnalytics() {
            showDownloadModal('🔍 Exportando Análisis de Compras', 'Preparando análisis detallado de compras...', () => {
                const { database, ref, get } = window.firebaseDB;
                
                get(ref(database, 'analytics/purchases')).then((snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        const csvContent = generatePurchaseAnalyticsCSV(data);
                        downloadCSV(csvContent, 'analisis_compras_detallado.csv');
                    } else {
                        showNotification('No hay datos de análisis de compras para exportar');
                    }
                }).catch((error) => {
                    console.error('Error exporting purchase analytics:', error);
                    showNotification('Error al exportar análisis de compras');
                });
            });
        }

        function exportSatisfactionAnalytics() {
            showDownloadModal('⭐ Exportando Análisis de Satisfacción', 'Preparando análisis de satisfacción de clientes...', () => {
                const { database, ref, get } = window.firebaseDB;
                
                get(ref(database, 'analytics/satisfaction')).then((snapshot) => {
                    if (snapshot.exists()) {
                        const data = snapshot.val();
                        const csvContent = generateSatisfactionAnalyticsCSV(data);
                        downloadCSV(csvContent, 'analisis_satisfaccion_clientes.csv');
                    } else {
                        showNotification('No hay datos de análisis de satisfacción para exportar');
                    }
                }).catch((error) => {
                    console.error('Error exporting satisfaction analytics:', error);
                    showNotification('Error al exportar análisis de satisfacción');
                });
            });
        }

        function exportCompleteAnalytics() {
            showDownloadModal('📊 Exportando Reporte Completo', 'Preparando reporte completo con todos los datos...', () => {
                const { database, ref, get } = window.firebaseDB;
                
                Promise.all([
                    get(ref(database, 'customerHistory')),
                    get(ref(database, 'orders')),
                    get(ref(database, 'analytics/purchases')),
                    get(ref(database, 'analytics/satisfaction')),
                    get(ref(database, 'productStats'))
                ]).then(([customerHistory, orders, purchases, satisfaction, productStats]) => {
                    const completeData = {
                        customerHistory: customerHistory.exists() ? customerHistory.val() : {},
                        orders: orders.exists() ? orders.val() : {},
                        purchases: purchases.exists() ? purchases.val() : {},
                        satisfaction: satisfaction.exists() ? satisfaction.val() : {},
                        productStats: productStats.exists() ? productStats.val() : {}
                    };
                    
                    const csvContent = generateCompleteAnalyticsCSV(completeData);
                    downloadCSV(csvContent, 'reporte_completo_smokeshop.csv');
                }).catch((error) => {
                    console.error('Error exporting complete analytics:', error);
                    showNotification('Error al exportar reporte completo');
                });
            });
        }

        function generatePurchaseAnalyticsCSV(data) {
            const headers = [
                'ID Pedido', 'Fecha', 'Cliente ID', 'Nombre Cliente', 'Total', 'Cantidad Items',
                'Método Pago', 'Barrio', 'Categorías Compradas', 'Productos Detalle', 'Hora Compra'
            ];
            
            let csv = headers.join(',') + '\n';
            
            Object.values(data).forEach(analytics => {
                const productsDetail = analytics.products.map(p => 
                    `${p.name} x${p.quantity} ($${p.price})`
                ).join('; ');
                
                const row = [
                    analytics.orderId,
                    new Date(analytics.date).toLocaleDateString(),
                    analytics.customerId,
                    `"${analytics.customerName}"`,
                    analytics.total,
                    analytics.itemCount,
                    analytics.paymentMethod,
                    `"${analytics.neighborhood}"`,
                    analytics.categories.join('; '),
                    `"${productsDetail}"`,
                    new Date(analytics.date).toLocaleTimeString()
                ];
                
                csv += row.join(',') + '\n';
            });
            
            return csv;
        }

        function generateSatisfactionAnalyticsCSV(data) {
            const headers = [
                'ID Reseña', 'Fecha', 'Cliente ID', 'Nombre Cliente', 'Producto ID', 
                'Calificación', 'Nivel Satisfacción', 'Comentario', 'Hora Reseña'
            ];
            
            let csv = headers.join(',') + '\n';
            
            Object.values(data).forEach(analytics => {
                const row = [
                    analytics.reviewId,
                    new Date(analytics.date).toLocaleDateString(),
                    analytics.customerId,
                    `"${analytics.customerName}"`,
                    analytics.productId,
                    analytics.rating,
                    analytics.satisfactionLevel,
                    `"${analytics.comment.replace(/"/g, '""')}"`,
                    new Date(analytics.date).toLocaleTimeString()
                ];
                
                csv += row.join(',') + '\n';
            });
            
            return csv;
        }

        function generateCompleteAnalyticsCSV(data) {
            const headers = [
                'RESUMEN EJECUTIVO',
                'Total Clientes Únicos', 'Total Pedidos', 'Total Ingresos', 'Total Reseñas',
                'Ticket Promedio', 'Satisfacción Promedio', 'Productos Más Vendidos', 'Barrios Principales',
                'Métodos Pago Populares', 'Categorías Top', 'Clientes VIP', 'Fecha Reporte'
            ];
            
            // Calcular métricas
            const totalCustomers = Object.keys(data.customerHistory).length;
            const totalOrders = Object.keys(data.orders).length;
            const totalRevenue = Object.values(data.orders).reduce((sum, order) => sum + order.total, 0);
            const totalReviews = Object.keys(data.satisfaction).length;
            const averageTicket = totalOrders > 0 ? Math.round(totalRevenue / totalOrders) : 0;
            
            const satisfactionRatings = Object.values(data.satisfaction).map(s => s.rating);
            const averageSatisfaction = satisfactionRatings.length > 0 ? 
                Math.round((satisfactionRatings.reduce((sum, r) => sum + r, 0) / satisfactionRatings.length) * 10) / 10 : 0;
            
            // Top productos
            const productSales = {};
            Object.values(data.purchases).forEach(purchase => {
                purchase.products.forEach(product => {
                    productSales[product.name] = (productSales[product.name] || 0) + product.quantity;
                });
            });
            const topProducts = Object.entries(productSales)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([name, qty]) => `${name} (${qty})`)
                .join('; ');
            
            // Top barrios
            const neighborhoods = {};
            Object.values(data.orders).forEach(order => {
                neighborhoods[order.neighborhood] = (neighborhoods[order.neighborhood] || 0) + 1;
            });
            const topNeighborhoods = Object.entries(neighborhoods)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([name, count]) => `${name} (${count})`)
                .join('; ');
            
            // Clientes VIP
            const vipCustomers = Object.values(data.customerHistory)
                .filter(customer => customer.totalOrders >= 5)
                .length;
            
            let csv = headers.join(',') + '\n';
            
            const summaryRow = [
                'DATOS GENERALES',
                totalCustomers,
                totalOrders,
                formatPrice(totalRevenue),
                totalReviews,
                formatPrice(averageTicket),
                `${averageSatisfaction} ⭐`,
                `"${topProducts}"`,
                `"${topNeighborhoods}"`,
                'Efectivo, Transferencia, Datáfono',
                'Papeles, Encendedores, Pipas',
                vipCustomers,
                new Date().toLocaleDateString()
            ];
            
            csv += summaryRow.join(',') + '\n\n';
            
            // Agregar datos detallados de clientes
            csv += 'DETALLE DE CLIENTES\n';
            csv += generateCustomerCSV(data.customerHistory);
            
            return csv;
        }

        // Modal de descarga con z-index alto
        function showDownloadModal(title, message, onConfirm) {
            const modal = document.createElement('div');
            modal.className = 'modal download-modal';
            modal.style.display = 'block';
            modal.style.zIndex = '9999997';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.95)';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backdropFilter = 'blur(5px)';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px; margin: 10% auto; position: relative; z-index: 10000000; background: white; border-radius: 20px; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5); border: 3px solid #10b981;">
                    <div class="text-center p-8">
                        <div class="text-6xl mb-4">📥</div>
                        <h2 class="text-2xl font-bold text-green-600 mb-4">${title}</h2>
                        <p class="text-gray-700 mb-8 text-lg leading-relaxed">${message}</p>
                        <div class="flex space-x-4">
                            <button onclick="this.closest('.modal').remove()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 px-6 rounded-lg font-semibold text-lg transition-all">
                                <i class="fas fa-times mr-2"></i>Cancelar
                            </button>
                            <button id="downloadBtn" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-3 px-6 rounded-lg font-semibold text-lg transition-all">
                                <i class="fas fa-download mr-2"></i>Descargar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Enfocar el modal
            modal.focus();
            
            modal.querySelector('#downloadBtn').addEventListener('click', () => {
                modal.remove();
                onConfirm();
            });
            
            // Cerrar con ESC
            const handleEsc = (e) => {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', handleEsc);
                }
            };
            document.addEventListener('keydown', handleEsc);
            
            // Prevenir scroll del fondo
            document.body.style.overflow = 'hidden';
            
            // Restaurar scroll cuando se cierre
            modal.addEventListener('remove', () => {
                document.body.style.overflow = '';
            });
        }

        function downloadCSV(csvContent, filename) {
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification(`📊 Archivo ${filename} descargado exitosamente`);
            } else {
                showNotification('Tu navegador no soporta la descarga de archivos');
            }
        }

        // Calculate quick statistics for admin panel
        async function calculateQuickStats() {
            try {
                const { database, ref, get } = window.firebaseDB;
                
                // Get customer history data
                const customerHistorySnapshot = await get(ref(database, 'customerHistory'));
                const customerHistoryData = customerHistorySnapshot.exists() ? customerHistorySnapshot.val() : {};
                
                // Calculate unique customers
                const uniqueCustomers = Object.keys(customerHistoryData).length;
                document.getElementById('uniqueCustomers').textContent = uniqueCustomers;
                
                // Calculate returning customers (more than 1 order)
                const returningCustomers = Object.values(customerHistoryData).filter(customer => customer.totalOrders > 1).length;
                document.getElementById('returningCustomers').textContent = `${returningCustomers} (${Math.round((returningCustomers/uniqueCustomers)*100) || 0}%)`;
                
                // Calculate average ticket
                const totalRevenue = customers.reduce((sum, c) => sum + c.total, 0);
                const averageTicket = customers.length > 0 ? totalRevenue / customers.length : 0;
                document.getElementById('averageTicket').textContent = formatPrice(Math.round(averageTicket));
                
                // Calculate average rating
                const totalRating = reviews.reduce((sum, r) => sum + r.rating, 0);
                const averageRating = reviews.length > 0 ? (totalRating / reviews.length).toFixed(1) : 0;
                document.getElementById('averageRating').textContent = `${averageRating} ⭐ (${reviews.length} reseñas)`;
                
            } catch (error) {
                console.error('Error calculating stats:', error);
                document.getElementById('uniqueCustomers').textContent = 'Error';
                document.getElementById('returningCustomers').textContent = 'Error';
                document.getElementById('averageTicket').textContent = 'Error';
                document.getElementById('averageRating').textContent = 'Error';
            }
        }

        // Order management functions
        function generateOrdersTable(orders) {
            if (orders.length === 0) {
                return '<p class="text-center text-gray-500 py-8">No hay pedidos para mostrar</p>';
            }
            
            return `
                <table class="w-full border-collapse border">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="border p-2">Fecha</th>
                            <th class="border p-2">Cliente</th>
                            <th class="border p-2">Teléfono</th>
                            <th class="border p-2">Total</th>
                            <th class="border p-2">Método Pago</th>
                            <th class="border p-2">Estado</th>
                            <th class="border p-2">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${orders.map(customer => `
                            <tr id="order-row-${customer.id}">
                                <td class="border p-2">${new Date(customer.date).toLocaleDateString()}</td>
                                <td class="border p-2">${customer.name}</td>
                                <td class="border p-2">${customer.phone}</td>
                                <td class="border p-2">${formatPrice(customer.total)}</td>
                                <td class="border p-2">${customer.paymentMethod}</td>
                                <td class="border p-2">
                                    <span class="px-2 py-1 rounded text-xs ${customer.status === 'completed' ? 'bg-green-100 text-green-800' : customer.status === 'cancelled' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'}">
                                        ${customer.status === 'completed' ? '✅ Completado' : customer.status === 'cancelled' ? '❌ Cancelado' : '⏳ Pendiente'}
                                    </span>
                                </td>
                                <td class="border p-2">
                                    <div class="flex space-x-1">
                                        ${customer.status !== 'completed' ? `
                                            <button onclick="updateOrderStatus(${customer.id}, 'completed')" class="bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded text-xs" title="Marcar como completado">
                                                <i class="fas fa-check"></i>
                                            </button>
                                        ` : ''}
                                        ${customer.status !== 'cancelled' ? `
                                            <button onclick="updateOrderStatus(${customer.id}, 'cancelled')" class="bg-red-500 hover:bg-red-600 text-white px-2 py-1 rounded text-xs" title="Marcar como cancelado">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        ` : ''}
                                        ${customer.status !== 'pending' ? `
                                            <button onclick="updateOrderStatus(${customer.id}, 'pending')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-2 py-1 rounded text-xs" title="Marcar como pendiente">
                                                <i class="fas fa-clock"></i>
                                            </button>
                                        ` : ''}
                                        <button onclick="viewOrderDetails(${customer.id})" class="bg-blue-500 hover:bg-blue-600 text-white px-2 py-1 rounded text-xs" title="Ver detalles">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button onclick="deleteOrder(${customer.id})" class="bg-gray-500 hover:bg-gray-600 text-white px-2 py-1 rounded text-xs" title="Eliminar pedido">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function filterOrders(status) {
            let filteredOrders;
            
            switch(status) {
                case 'pending':
                    filteredOrders = customers.filter(c => c.status !== 'completed' && c.status !== 'cancelled');
                    break;
                case 'completed':
                    filteredOrders = customers.filter(c => c.status === 'completed');
                    break;
                case 'cancelled':
                    filteredOrders = customers.filter(c => c.status === 'cancelled');
                    break;
                default:
                    filteredOrders = customers;
            }
            
            const ordersTable = document.getElementById('ordersTable');
            ordersTable.innerHTML = generateOrdersTable(filteredOrders.slice(-20).reverse());
        }

        async function updateOrderStatus(orderId, newStatus) {
            try {
                const order = customers.find(c => c.id === orderId);
                if (!order) {
                    showNotification('Pedido no encontrado');
                    return;
                }
                
                const statusNames = {
                    'pending': 'Pendiente',
                    'completed': 'Completado',
                    'cancelled': 'Cancelado'
                };
                
                showOrderStatusModal(
                    '¿Cambiar Estado del Pedido?',
                    `¿Estás seguro de cambiar el estado del pedido de ${order.name} a "${statusNames[newStatus]}"?`,
                    async () => {
                        // Update in Firebase
                        const { database, ref, update } = window.firebaseDB;
                        const firebaseKey = order.firebaseKey || orderId;
                        await update(ref(database, `orders/${firebaseKey}`), {
                            status: newStatus,
                            statusUpdated: new Date().toISOString()
                        });
                        
                        // Update local array
                        order.status = newStatus;
                        order.statusUpdated = new Date().toISOString();
                        
                        // Refresh the admin panel
                        showAdminSection('customers');
                        
                        showNotification(`Estado del pedido actualizado a "${statusNames[newStatus]}"`);
                        showSyncIndicator('Estado actualizado', true);
                        setTimeout(() => hideSyncIndicator(), 2000);
                    },
                    'Cambiar Estado',
                    'fas fa-sync-alt'
                );
                
            } catch (error) {
                console.error('Error updating order status:', error);
                showNotification('Error al actualizar el estado del pedido');
                showSyncIndicator('Error al actualizar', false);
            }
        }

        function viewOrderDetails(orderId) {
            const order = customers.find(c => c.id === orderId);
            if (!order) {
                showNotification('Pedido no encontrado');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal order-details-modal';
            modal.style.display = 'block';
            modal.style.zIndex = '80000';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.95)';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backdropFilter = 'blur(5px)';
            
            const itemsList = order.items.map(item => {
                const imageDisplay = item.image && item.image.startsWith('data:') ? 
                    `<img src="${item.image}" alt="${item.name}" class="w-12 h-12 object-cover rounded-lg border-2 border-purple-200">` :
                    `<span class="text-2xl">${item.image || '📦'}</span>`;
                
                return `
                    <div class="flex justify-between items-center py-2 border-b">
                        <div class="flex items-center space-x-3">
                            ${imageDisplay}
                            <div>
                                <span class="font-semibold">${item.name}</span>
                                <div class="text-sm text-gray-600">x${item.quantity} - ${formatPrice(item.price)} c/u</div>
                            </div>
                        </div>
                        <span class="font-semibold">${formatPrice(item.price * item.quantity)}</span>
                    </div>
                `;
            }).join('');
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-purple-800">Detalles del Pedido</h2>
                        <button onclick="this.closest('.modal').remove()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
                    </div>
                    
                    <div class="space-y-6">
                        <!-- Información del cliente -->
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h3 class="font-bold text-lg mb-3 text-blue-800">👤 Información del Cliente</h3>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div><strong>Nombre:</strong> ${order.name}</div>
                                <div><strong>Teléfono:</strong> ${order.phone}</div>
                                <div><strong>Dirección:</strong> ${order.address}</div>
                                <div><strong>Barrio:</strong> ${order.neighborhood}</div>
                                <div><strong>Método de pago:</strong> ${order.paymentMethod}</div>
                                <div><strong>Fecha del pedido:</strong> ${new Date(order.date).toLocaleString()}</div>
                            </div>
                        </div>
                        
                        <!-- Estado del pedido -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="font-bold text-lg mb-3">📊 Estado del Pedido</h3>
                            <div class="flex items-center space-x-4">
                                <span class="px-4 py-2 rounded-lg text-sm font-semibold ${order.status === 'completed' ? 'bg-green-100 text-green-800' : order.status === 'cancelled' ? 'bg-red-100 text-red-800' : 'bg-yellow-100 text-yellow-800'}">
                                    ${order.status === 'completed' ? '✅ Completado' : order.status === 'cancelled' ? '❌ Cancelado' : '⏳ Pendiente'}
                                </span>
                                ${order.statusUpdated ? `<span class="text-xs text-gray-500">Actualizado: ${new Date(order.statusUpdated).toLocaleString()}</span>` : ''}
                            </div>
                        </div>
                        
                        <!-- Productos -->
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h3 class="font-bold text-lg mb-3">🛒 Productos</h3>
                            ${itemsList}
                            <div class="flex justify-between items-center pt-3 mt-3 border-t-2 border-purple-200">
                                <span class="text-xl font-bold">Total:</span>
                                <span class="text-2xl font-bold text-green-600">${formatPrice(order.total)}</span>
                            </div>
                        </div>
                        
                        <!-- Acciones rápidas -->
                        <div class="flex space-x-2">
                            ${order.status !== 'completed' ? `
                                <button onclick="updateOrderStatus(${order.id}, 'completed'); this.closest('.modal').remove();" class="flex-1 bg-green-500 hover:bg-green-600 text-white py-2 px-4 rounded-lg font-semibold">
                                    <i class="fas fa-check mr-2"></i>Marcar Completado
                                </button>
                            ` : ''}
                            ${order.status !== 'cancelled' ? `
                                <button onclick="updateOrderStatus(${order.id}, 'cancelled'); this.closest('.modal').remove();" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-2 px-4 rounded-lg font-semibold">
                                    <i class="fas fa-times mr-2"></i>Cancelar Pedido
                                </button>
                            ` : ''}
                            ${order.status !== 'pending' ? `
                                <button onclick="updateOrderStatus(${order.id}, 'pending'); this.closest('.modal').remove();" class="flex-1 bg-yellow-500 hover:bg-yellow-600 text-white py-2 px-4 rounded-lg font-semibold">
                                    <i class="fas fa-clock mr-2"></i>Marcar Pendiente
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        async function deleteOrder(orderId) {
            try {
                const order = customers.find(c => c.id === orderId);
                if (!order) {
                    showNotification('Pedido no encontrado');
                    return;
                }
                
                showConfirmationModal(
                    '¿Eliminar Pedido?',
                    `¿Estás seguro de eliminar el pedido de ${order.name}? Esta acción no se puede deshacer y eliminará todos los datos relacionados.`,
                    async () => {
                        // Delete from Firebase
                        const { database, ref, remove } = window.firebaseDB;
                        const firebaseKey = order.firebaseKey || orderId;
                        await remove(ref(database, `orders/${firebaseKey}`));
                        
                        // Update local array
                        customers = customers.filter(c => c.id !== orderId);
                        
                        // Refresh the admin panel
                        showAdminSection('customers');
                        
                        showNotification('Pedido eliminado exitosamente');
                        showSyncIndicator('Pedido eliminado', true);
                        setTimeout(() => hideSyncIndicator(), 2000);
                    }
                );
                
            } catch (error) {
                console.error('Error deleting order:', error);
                showNotification('Error al eliminar el pedido');
                showSyncIndicator('Error al eliminar', false);
            }
        }

        // Utility functions
        function generateOrderNumber() {
            return 'PS' + Date.now().toString().slice(-8);
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Modal de confirmación con z-index súper alto
        function showConfirmationModal(title, message, onConfirm, confirmText = 'Eliminar', confirmIcon = 'fas fa-trash') {
            const modal = document.createElement('div');
            modal.className = 'modal confirmation-modal';
            modal.style.display = 'block';
            modal.style.zIndex = '9999999';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.95)';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backdropFilter = 'blur(5px)';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px; margin: 10% auto; position: relative; z-index: 10000000; background: white; border-radius: 20px; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5); border: 3px solid #a855f7;">
                    <div class="text-center p-8">
                        <div class="text-6xl mb-4">⚠️</div>
                        <h2 class="text-2xl font-bold text-red-600 mb-4">${title}</h2>
                        <p class="text-gray-700 mb-8 text-lg leading-relaxed">${message}</p>
                        <div class="flex space-x-4">
                            <button onclick="this.closest('.modal').remove()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 px-6 rounded-lg font-semibold text-lg transition-all">
                                <i class="fas fa-times mr-2"></i>Cancelar
                            </button>
                            <button id="confirmBtn" class="flex-1 bg-red-500 hover:bg-red-600 text-white py-3 px-6 rounded-lg font-semibold text-lg transition-all">
                                <i class="${confirmIcon} mr-2"></i>${confirmText}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Enfocar el modal
            modal.focus();
            
            modal.querySelector('#confirmBtn').addEventListener('click', () => {
                modal.remove();
                onConfirm();
            });
            
            // Cerrar con ESC
            const handleEsc = (e) => {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', handleEsc);
                }
            };
            document.addEventListener('keydown', handleEsc);
            
            // Prevenir scroll del fondo
            document.body.style.overflow = 'hidden';
            
            // Restaurar scroll cuando se cierre
            modal.addEventListener('remove', () => {
                document.body.style.overflow = '';
            });
        }

        // Modal específico para cambio de estado de pedidos
        function showOrderStatusModal(title, message, onConfirm, confirmText = 'Cambiar Estado', confirmIcon = 'fas fa-sync-alt') {
            const modal = document.createElement('div');
            modal.className = 'modal order-status-modal';
            modal.style.display = 'block';
            modal.style.zIndex = '85000';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.95)';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backdropFilter = 'blur(5px)';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px; margin: 10% auto; position: relative; z-index: 10000000; background: white; border-radius: 20px; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5); border: 3px solid #3b82f6;">
                    <div class="text-center p-8">
                        <div class="text-6xl mb-4">📋</div>
                        <h2 class="text-2xl font-bold text-blue-600 mb-4">${title}</h2>
                        <p class="text-gray-700 mb-8 text-lg leading-relaxed">${message}</p>
                        <div class="flex space-x-4">
                            <button onclick="this.closest('.modal').remove()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 px-6 rounded-lg font-semibold text-lg transition-all">
                                <i class="fas fa-times mr-2"></i>Cancelar
                            </button>
                            <button id="confirmBtn" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold text-lg transition-all">
                                <i class="${confirmIcon} mr-2"></i>${confirmText}
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Enfocar el modal
            modal.focus();
            
            modal.querySelector('#confirmBtn').addEventListener('click', () => {
                modal.remove();
                onConfirm();
            });
            
            // Cerrar con ESC
            const handleEsc = (e) => {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', handleEsc);
                }
            };
            document.addEventListener('keydown', handleEsc);
            
            // Prevenir scroll del fondo
            document.body.style.overflow = 'hidden';
            
            // Restaurar scroll cuando se cierre
            modal.addEventListener('remove', () => {
                document.body.style.overflow = '';
            });
        }

        // Modal de verificación de teléfono
        function showPhoneVerificationModal(title, message, expectedPhone, onSuccess) {
            const modal = document.createElement('div');
            modal.className = 'modal phone-verification-modal';
            modal.style.display = 'block';
            modal.style.zIndex = '9999998';
            modal.style.backgroundColor = 'rgba(0, 0, 0, 0.95)';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.width = '100%';
            modal.style.height = '100%';
            modal.style.backdropFilter = 'blur(5px)';
            
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px; margin: 10% auto; position: relative; z-index: 10000000; background: white; border-radius: 20px; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5); border: 3px solid #3b82f6;">
                    <div class="text-center p-8">
                        <div class="text-6xl mb-4">🔐</div>
                        <h2 class="text-2xl font-bold text-blue-600 mb-4">${title}</h2>
                        <p class="text-gray-700 mb-6 text-lg">${message}</p>
                        <input type="tel" id="phoneInput" placeholder="Ingresa tu teléfono" class="w-full p-4 border-2 rounded-lg text-lg text-center mb-6 focus:border-blue-400">
                        <div class="flex space-x-4">
                            <button onclick="this.closest('.modal').remove()" class="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 px-6 rounded-lg font-semibold text-lg transition-all">
                                <i class="fas fa-times mr-2"></i>Cancelar
                            </button>
                            <button id="verifyBtn" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-3 px-6 rounded-lg font-semibold text-lg transition-all">
                                <i class="fas fa-check mr-2"></i>Verificar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            const phoneInput = modal.querySelector('#phoneInput');
            const verifyBtn = modal.querySelector('#verifyBtn');
            
            phoneInput.focus();
            
            const verify = () => {
                const enteredPhone = phoneInput.value.trim();
                if (enteredPhone === expectedPhone) {
                    modal.remove();
                    onSuccess();
                } else {
                    phoneInput.style.borderColor = '#ef4444';
                    phoneInput.style.backgroundColor = '#fef2f2';
                    showNotification('Número de teléfono incorrecto. Solo puedes editar tus propias reseñas.');
                    setTimeout(() => {
                        phoneInput.style.borderColor = '';
                        phoneInput.style.backgroundColor = '';
                        phoneInput.focus();
                        phoneInput.select();
                    }, 2000);
                }
            };
            
            verifyBtn.addEventListener('click', verify);
            phoneInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    verify();
                }
            });
            
            // Cerrar con ESC
            const handleEsc = (e) => {
                if (e.key === 'Escape') {
                    modal.remove();
                    document.removeEventListener('keydown', handleEsc);
                }
            };
            document.addEventListener('keydown', handleEsc);
        }

        // Initialize the app when DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // The app will be initialized when Firebase is ready
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'97a722ce8513f78a',t:'MTc1NzA5MDA4Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
